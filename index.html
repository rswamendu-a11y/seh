<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Samsung Enterprise Hub</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@500;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Inter', 'sans-serif'],
                        display: ['Outfit', 'sans-serif']
                    },
                    colors: { 
                        slate: { 850: '#151f32', 900: '#0f172a', 950: '#020617' },
                        brand: { 400: '#38bdf8', 500: '#0ea5e9', 600: '#0284c7' }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'fade-in-up': 'fadeInUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        fadeInUp: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }
                    }
                }
            }
        }
    </script>
    
    <!-- React & Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Utilities -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
        body { background-color: #020617; -webkit-tap-highlight-color: transparent; color: #e2e8f0; }
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .glass-card {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.6), rgba(15, 23, 42, 0.8));
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.2s ease-in-out;
        }
        .glass-card:hover { border-color: rgba(56, 189, 248, 0.2); }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(148, 163, 184, 0.2); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(148, 163, 184, 0.4); }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* Calendar/Date Input custom style */
        input[type="date"]::-webkit-calendar-picker-indicator,
        input[type="month"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- UTILS: IndexedDB for Docs ---
        const DB_NAME = 'SECDocsDB';
        const DB_STORE = 'files';
        
        const initDB = () => {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, 1);
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains(DB_STORE)) {
                        db.createObjectStore(DB_STORE, { keyPath: 'id', autoIncrement: true });
                    }
                };
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        };

        const saveFileToDB = async (file) => {
            const db = await initDB();
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const tx = db.transaction(DB_STORE, 'readwrite');
                    const store = tx.objectStore(DB_STORE);
                    const item = {
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        date: new Date(),
                        data: reader.result // ArrayBuffer
                    };
                    store.add(item);
                    tx.oncomplete = () => resolve(true);
                    tx.onerror = () => reject(tx.error);
                };
                reader.readAsArrayBuffer(file);
            });
        };

        const getFilesFromDB = async () => {
            const db = await initDB();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(DB_STORE, 'readonly');
                const store = tx.objectStore(DB_STORE);
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        };

        const deleteFileFromDB = async (id) => {
            const db = await initDB();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(DB_STORE, 'readwrite');
                const store = tx.objectStore(DB_STORE);
                store.delete(id);
                tx.oncomplete = () => resolve(true);
            });
        };

        // --- COMPONENTS ---
        
        const LucideIcon = ({ name, size = 18, className = "", onClick }) => {
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [name]);
            return <i data-lucide={name} onClick={onClick} style={{ width: size, height: size }} className={className}></i>;
        };

        const LockScreen = ({ onUnlock }) => {
            const [pin, setPin] = useState("");
            const [error, setError] = useState(false);

            const handleUnlock = () => {
                const stored = localStorage.getItem('sec_app_pin');
                if (stored && pin === stored) {
                    onUnlock();
                } else {
                    setError(true);
                    setPin("");
                    setTimeout(() => setError(false), 1000);
                }
            };

            return (
                <div className="fixed inset-0 z-[100] bg-slate-950 flex flex-col items-center justify-center p-4 animate-fade-in">
                    <div className="w-16 h-16 rounded-2xl bg-gradient-to-br from-brand-400 to-indigo-600 flex items-center justify-center shadow-lg shadow-brand-500/20 mb-8">
                        <LucideIcon name="lock" className="text-white" size={32} />
                    </div>
                    <h2 className="text-2xl font-bold text-white mb-2">Security Lock</h2>
                    <p className="text-slate-400 text-sm mb-8">Enter your PIN to access the hub.</p>
                    
                    <div className="flex gap-4 mb-8">
                        {[0, 1, 2, 3].map((i) => (
                            <div key={i} className={`w-4 h-4 rounded-full transition-all duration-300 ${pin.length > i ? 'bg-brand-500 scale-110 shadow-[0_0_10px_rgba(14,165,233,0.5)]' : 'bg-slate-800'}`}></div>
                        ))}
                    </div>

                    <div className="grid grid-cols-3 gap-4 w-full max-w-xs">
                        {[1, 2, 3, 4, 5, 6, 7, 8, 9, 'C', 0, 'Go'].map(n => (
                            <button 
                                key={n}
                                onClick={() => {
                                    if(n === 'C') setPin(pin.slice(0, -1));
                                    else if(n === 'Go') handleUnlock();
                                    else if(pin.length < 4) setPin(pin + n);
                                }}
                                className={`h-16 rounded-2xl font-bold text-xl transition-all active:scale-95 flex items-center justify-center ${
                                    n === 'Go' ? 'bg-brand-600 text-white shadow-lg shadow-brand-500/20' : 
                                    n === 'C' ? 'bg-red-500/10 text-red-500 hover:bg-red-500/20' : 
                                    'bg-slate-800 text-white hover:bg-slate-700'
                                }`}
                            >
                                {n === 'Go' ? <LucideIcon name="arrow-right" /> : n === 'C' ? <LucideIcon name="delete" /> : n}
                            </button>
                        ))}
                    </div>
                    {error && <p className="text-red-500 mt-6 animate-bounce font-bold">Incorrect PIN</p>}
                </div>
            );
        };

        const SecuritySettings = ({ isOpen, onClose }) => {
            const [mode, setMode] = useState('menu'); // menu, set, change
            const [step, setStep] = useState(0); // 0: old, 1: new, 2: confirm
            const [buffer, setBuffer] = useState("");
            const [newPin, setNewPin] = useState("");
            const toast = useToast();
            const confirm = useConfirm();
            
            const hasPin = !!localStorage.getItem('sec_app_pin');

            const handleSetPin = (pin) => {
                if(step === 1) {
                    setNewPin(pin);
                    setBuffer("");
                    setStep(2);
                } else if (step === 2) {
                    if(pin === newPin) {
                        localStorage.setItem('sec_app_pin', pin);
                        toast.addToast("Security PIN Set Successfully!", "success");
                        onClose();
                    } else {
                        toast.addToast("PINs do not match. Try again.", "error");
                        setBuffer("");
                        setStep(1);
                    }
                }
            };

            const handleRemove = () => {
                confirm({
                    title: "Remove Security PIN?",
                    message: "Are you sure? Anyone will be able to access the app without a PIN.",
                    isDanger: true,
                    onConfirm: () => {
                        localStorage.removeItem('sec_app_pin');
                        toast.addToast("Security PIN Removed.", "info");
                        onClose();
                    }
                });
            };

            const renderKeypad = (onEnter, label) => (
                <div className="flex flex-col items-center">
                    <h3 className="text-white font-bold mb-4">{label}</h3>
                    <div className="flex gap-4 mb-6">
                        {[0, 1, 2, 3].map((i) => (
                            <div key={i} className={`w-3 h-3 rounded-full ${buffer.length > i ? 'bg-brand-500' : 'bg-slate-700'}`}></div>
                        ))}
                    </div>
                    <div className="grid grid-cols-3 gap-3 w-full max-w-[240px]">
                        {[1, 2, 3, 4, 5, 6, 7, 8, 9, 'C', 0, 'OK'].map(n => (
                            <button 
                                key={n}
                                onClick={() => {
                                    if(n === 'C') setBuffer(buffer.slice(0, -1));
                                    else if(n === 'OK') { if(buffer.length === 4) onEnter(buffer); }
                                    else if(buffer.length < 4) setBuffer(buffer + n);
                                }}
                                className="h-12 bg-slate-800 rounded-xl text-white font-bold hover:bg-slate-700 active:scale-95 flex items-center justify-center"
                            >
                                {n === 'OK' ? <LucideIcon name="check" size={16}/> : n === 'C' ? <LucideIcon name="delete" size={16}/> : n}
                            </button>
                        ))}
                    </div>
                </div>
            );

            if(!isOpen) return null;

            return (
                <Modal isOpen={isOpen} onClose={onClose} title="Security Settings">
                    {mode === 'menu' && (
                        <div className="space-y-3">
                            <div className="p-4 bg-brand-500/10 border border-brand-500/20 rounded-xl mb-4">
                                <div className="flex items-center gap-3 mb-2">
                                    <div className={`w-10 h-10 rounded-full flex items-center justify-center ${hasPin ? 'bg-emerald-500/20 text-emerald-400' : 'bg-slate-700 text-slate-400'}`}>
                                        <LucideIcon name={hasPin ? "lock" : "unlock"} />
                                    </div>
                                    <div>
                                        <h4 className="font-bold text-white">{hasPin ? "App Secured" : "Unsecured"}</h4>
                                        <p className="text-xs text-slate-400">{hasPin ? "PIN protection is active." : "Set a PIN to protect your data."}</p>
                                    </div>
                                </div>
                            </div>
                            
                            {!hasPin ? (
                                <Button onClick={()=>{setMode('set'); setStep(1); setBuffer("");}} className="w-full" icon="plus">Set New PIN</Button>
                            ) : (
                                <>
                                    <Button onClick={()=>{setMode('set'); setStep(1); setBuffer("");}} variant="secondary" className="w-full" icon="refresh-cw">Change PIN</Button>
                                    <Button onClick={handleRemove} variant="danger" className="w-full" icon="unlock">Remove Security</Button>
                                </>
                            )}
                        </div>
                    )}

                    {mode === 'set' && (
                        <div>
                            <button onClick={()=>setMode('menu')} className="mb-4 text-xs text-slate-400 hover:text-white flex items-center gap-1"><LucideIcon name="arrow-left" size={14}/> Back</button>
                            {renderKeypad(handleSetPin, step === 1 ? "Enter New PIN" : "Confirm New PIN")}
                        </div>
                    )}
                </Modal>
            );
        };

        const Card = ({ children, className = "" }) => (
            <div className={`glass-card rounded-2xl p-5 ${className}`}>{children}</div>
        );

        const Button = ({ children, onClick, variant = 'primary', className = "", icon = null }) => {
            const base = "px-4 py-3 rounded-xl font-bold text-sm transition-all active:scale-95 flex items-center justify-center gap-2";
            const variants = {
                primary: "bg-brand-600 text-white shadow-lg shadow-brand-900/20 hover:bg-brand-500",
                secondary: "bg-slate-700 text-slate-200 hover:bg-slate-600",
                outline: "border border-slate-600 text-slate-400 hover:bg-slate-800 hover:text-white",
                danger: "bg-red-500/10 text-red-500 border border-red-500/20 hover:bg-red-500/20"
            };
            return (
                <button onClick={onClick} className={`${base} ${variants[variant]} ${className}`}>
                    {icon && <LucideIcon name={icon} size={18} />}
                    {children}
                </button>
            );
        };

        const Input = ({ label, value, onChange, type = "text", placeholder = "", className = "" }) => (
            <div className={`w-full ${className}`}>
                {label && <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1.5 block ml-1">{label}</label>}
                <input 
                    type={type} 
                    value={value} 
                    onChange={onChange} 
                    placeholder={placeholder}
                    className="w-full h-12 px-4 rounded-xl bg-slate-800/50 border border-slate-700 text-sm font-bold text-white focus:border-brand-500 focus:outline-none focus:ring-1 focus:ring-brand-500/50 placeholder-slate-500 transition-all"
                />
            </div>
        );

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-fade-in">
                    <div className="bg-slate-900 border border-slate-700 rounded-3xl w-full max-w-lg max-h-[90vh] overflow-hidden flex flex-col shadow-2xl">
                        <div className="p-4 border-b border-slate-800 flex justify-between items-center bg-slate-800/50">
                            <h3 className="font-bold text-white text-lg">{title}</h3>
                            <button onClick={onClose} className="p-2 hover:bg-slate-700 rounded-lg text-slate-400 hover:text-white"><LucideIcon name="x" /></button>
                        </div>
                        <div className="p-6 overflow-y-auto custom-scrollbar">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        const ConfirmModal = ({ isOpen, onClose, onConfirm, title, message, confirmText = "Confirm", cancelText = "Cancel", isDanger = false }) => {
            if (!isOpen) return null;
            return (
                <Modal isOpen={isOpen} onClose={onClose} title={title}>
                    <div className="space-y-4">
                        <p className="text-slate-300 text-sm">{message}</p>
                        <div className="flex gap-3 justify-end">
                            <Button onClick={onClose} variant="secondary">{cancelText}</Button>
                            <Button onClick={() => { onConfirm(); }} variant={isDanger ? "danger" : "primary"}>{confirmText}</Button>
                        </div>
                    </div>
                </Modal>
            );
        };

        // --- CONTEXTS & PROVIDERS ---
        const ToastContext = React.createContext();
        const useToast = () => React.useContext(ToastContext);

        const ToastProvider = ({ children }) => {
            const [toasts, setToasts] = useState([]);

            const addToast = (message, type = 'info') => {
                const id = Date.now() + Math.random();
                setToasts(prev => [...prev, { id, message, type }]);
                setTimeout(() => removeToast(id), 3000);
            };

            const removeToast = (id) => {
                setToasts(prev => prev.filter(t => t.id !== id));
            };

            return (
                <ToastContext.Provider value={{ addToast }}>
                    {children}
                    <div className="fixed bottom-4 right-4 z-[110] flex flex-col gap-2">
                        {toasts.map(t => (
                            <div key={t.id} className={`min-w-[200px] p-4 rounded-xl shadow-lg border backdrop-blur-md animate-fade-in-up flex items-center gap-3 ${
                                t.type === 'error' ? 'bg-red-500/10 border-red-500/20 text-red-400' :
                                t.type === 'success' ? 'bg-emerald-500/10 border-emerald-500/20 text-emerald-400' :
                                'bg-slate-800/90 border-slate-700 text-white'
                            }`}>
                                <LucideIcon name={t.type === 'error' ? 'alert-circle' : t.type === 'success' ? 'check-circle' : 'info'} size={20} />
                                <span className="text-sm font-bold">{t.message}</span>
                            </div>
                        ))}
                    </div>
                </ToastContext.Provider>
            );
        };

        const ConfirmContext = React.createContext();
        const useConfirm = () => React.useContext(ConfirmContext);

        const ConfirmProvider = ({ children }) => {
            const [state, setState] = useState({ isOpen: false, title: "", message: "", onConfirm: null, isDanger: false });

            const confirm = ({ title = "Confirm", message, onConfirm, isDanger = false }) => {
                setState({ isOpen: true, title, message, onConfirm, isDanger });
            };

            const handleConfirm = () => {
                if(state.onConfirm) state.onConfirm();
                setState(prev => ({ ...prev, isOpen: false }));
            };

            const handleClose = () => setState(prev => ({ ...prev, isOpen: false }));

            return (
                <ConfirmContext.Provider value={confirm}>
                    {children}
                    <ConfirmModal 
                        isOpen={state.isOpen} 
                        onClose={handleClose} 
                        onConfirm={handleConfirm}
                        title={state.title}
                        message={state.message}
                        isDanger={state.isDanger}
                    />
                </ConfirmContext.Provider>
            );
        };

        // --- MAIN APP COMPONENT ---
        const App = () => {
            const [view, setView] = useState('home'); // home, tracker, incentive, docs
            const [isLocked, setIsLocked] = useState(false);
            const [showSecurity, setShowSecurity] = useState(false);

            useEffect(() => {
                const hasPin = !!localStorage.getItem('sec_app_pin');
                if (hasPin) setIsLocked(true);
            }, []);

            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [view, isLocked]);

            if (isLocked) {
                return <LockScreen onUnlock={() => setIsLocked(false)} />;
            }

            return (
                <div className="min-h-screen relative flex flex-col">
                    <SecuritySettings isOpen={showSecurity} onClose={() => setShowSecurity(false)} />
                    
                    {/* Background Elements */}
                    <div className="fixed top-0 left-0 w-full h-full overflow-hidden -z-10 pointer-events-none">
                        <div className="absolute top-[-10%] left-[-10%] w-[500px] h-[500px] bg-brand-600/10 rounded-full blur-[120px]"></div>
                        <div className="absolute bottom-[-10%] right-[-10%] w-[400px] h-[400px] bg-indigo-600/10 rounded-full blur-[100px]"></div>
                    </div>

                    {/* Navigation Header (Sticky) */}
                    {view !== 'home' && (
                        <header className="sticky top-0 z-40 bg-slate-950/80 backdrop-blur-md border-b border-white/5 px-4 py-3 flex items-center justify-between">
                            <div className="flex items-center gap-3 cursor-pointer" onClick={() => setView('home')}>
                                <div className="w-8 h-8 rounded-lg bg-gradient-to-br from-brand-400 to-indigo-600 flex items-center justify-center shadow-lg shadow-brand-500/20">
                                    <span className="font-display font-bold text-white text-sm">S</span>
                                </div>
                                <h1 className="font-display font-bold text-base text-white">Enterprise Hub</h1>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={() => setView('home')} className="p-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg"><LucideIcon name="home" /></button>
                            </div>
                        </header>
                    )}

                    {/* Views */}
                    <main className="flex-1 w-full max-w-5xl mx-auto">
                        {view === 'home' && <HomeView setView={setView} openSecurity={() => setShowSecurity(true)} />}
                        {view === 'tracker' && <SalesTracker />}
                        {view === 'incentive' && <IncentiveCalculator />}
                        {view === 'docs' && <DocsHub />}
                    </main>
                </div>
            );
        };
        
        // --- HOME VIEW ---
        const HomeView = ({ setView, openSecurity }) => {
             const tools = [
                { id: 'tracker', title: "Daily Sales Tracker", subtitle: "Version 15.3", desc: "Track daily volumes, visualize trends, and manage targets.", icon: "bar-chart-2", color: "text-brand-400", bg: "bg-brand-500/10" },
                { id: 'incentive', title: "Incentive Calculator", subtitle: "Hybrid Structure", desc: "Calculate payouts with slabs, gates, and kicker logic.", icon: "calculator", color: "text-emerald-400", bg: "bg-emerald-500/10" },
                { id: 'docs', title: "Scheme Documents", subtitle: "Resource Hub", desc: "Store and view monthly scheme PDFs and policy docs.", icon: "file-text", color: "text-purple-400", bg: "bg-purple-500/10" }
            ];

            return (
                <div className="px-6 py-12 flex flex-col justify-center min-h-[80vh]">
                     <div className="mb-12 animate-fade-in-up flex justify-between items-start">
                        <div>
                            <div className="w-12 h-12 mb-6 rounded-2xl bg-gradient-to-br from-brand-400 to-indigo-600 flex items-center justify-center shadow-lg shadow-brand-500/20">
                                <span className="font-display font-bold text-white text-xl">S</span>
                            </div>
                            <h2 className="text-4xl font-display font-bold text-white mb-3">
                                Welcome Back.
                            </h2>
                            <p className="text-slate-400 text-lg max-w-md">
                                Your centralized command center for sales tracking and incentive management.
                            </p>
                        </div>
                        <button onClick={openSecurity} className="p-3 bg-slate-800 rounded-xl text-slate-400 hover:text-white hover:bg-slate-700 transition-all">
                            <LucideIcon name="shield-check" size={24} />
                        </button>
                    </div>
                    
                    <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                        {tools.map((tool, idx) => (
                            <div 
                                key={tool.id} 
                                onClick={() => setView(tool.id)}
                                className="glass-card p-6 rounded-2xl group cursor-pointer animate-fade-in-up hover:border-brand-500/30"
                                style={{animationDelay: `${0.1 + (idx * 0.1)}s`}}
                            >
                                <div className="flex items-start justify-between mb-4">
                                    <div className={`w-14 h-14 rounded-2xl ${tool.bg} ${tool.color} flex items-center justify-center border border-white/5`}>
                                        <LucideIcon name={tool.icon} size={28} />
                                    </div>
                                    <LucideIcon name="arrow-right" size={20} className="text-slate-600 group-hover:text-brand-400 group-hover:translate-x-1 transition-all" />
                                </div>
                                <h3 className="text-xl font-bold text-white mb-1 group-hover:text-brand-400 transition-colors">{tool.title}</h3>
                                <p className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3">{tool.subtitle}</p>
                                <p className="text-sm text-slate-400 leading-relaxed">{tool.desc}</p>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const SalesTracker = () => {
            const [view, setView] = useState('entry'); // entry, report, analytics, profile
            const [showImportExport, setShowImportExport] = useState(false);
            
            const [salesData, setSalesData] = useState(() => {
                const v15 = localStorage.getItem('sec_sales_data_v15');
                if (v15) return JSON.parse(v15);
                return {};
            });
            const [profile, setProfile] = useState(() => JSON.parse(localStorage.getItem('sec_profile_v15') || '{"name":"","code":"","outlet":"","outletCode":"","managerName":"","managerCode":"","targetVol":0,"targetVal":0}'));
            const [currentDate, setCurrentDate] = useState(new Date().toISOString().split('T')[0]);
            
            // New: Independent Month for Reporting
            const [reportMonth, setReportMonth] = useState(new Date().toISOString().slice(0, 7)); // YYYY-MM

            // Queue & Inputs
            const [pendingQueue, setPendingQueue] = useState([]);
            const [inputBrand, setInputBrand] = useState('');
            const [inputModel, setInputModel] = useState('');
            const [inputVariant, setInputVariant] = useState('');
            const [inputPrice, setInputPrice] = useState('');
            const [inputQty, setInputQty] = useState(1);
            
            const toast = useToast();
            const confirm = useConfirm();

            const brandsList = [
                { key: 'samsung', label: 'Samsung', aliases: ['samsung', 'sam'], color: '#3b82f6' },
                { key: 'iphone', label: 'Apple', aliases: ['iphone', 'apple', 'app'], color: '#64748b' },
                { key: 'realme', label: 'Realme', aliases: ['realme', 'real'], color: '#eab308' },
                { key: 'mi', label: 'Xiaomi', aliases: ['mi', 'xiaomi', 'redmi'], color: '#f97316' },
                { key: 'oppo', label: 'Oppo', aliases: ['oppo', 'opp'], color: '#10b981' },
                { key: 'vivo', label: 'Vivo', aliases: ['vivo', 'viv'], color: '#06b6d4' },
                { key: 'moto', label: 'Moto', aliases: ['moto', 'motorola'], color: '#6366f1' },
                { key: 'other', label: 'Others', aliases: ['other', 'oth'], color: '#94a3b8' },
            ];

            useEffect(() => { localStorage.setItem('sec_sales_data_v15', JSON.stringify(salesData)); }, [salesData]);
            useEffect(() => { localStorage.setItem('sec_profile_v15', JSON.stringify(profile)); }, [profile]);

            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            // --- ANALYTICS ---
            useEffect(() => {
                if (view === 'analytics' && chartRef.current) {
                    if (chartInstance.current) chartInstance.current.destroy();
                    const ctx = chartRef.current.getContext('2d');
                    
                    const stats = calculateStats(reportMonth);
                    const mtdData = stats.mtd.breakdownVol;
                    const labels = brandsList.map(b => b.label);
                    const data = brandsList.map(b => mtdData[b.key]);
                    const colors = brandsList.map(b => b.color);

                    chartInstance.current = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: labels,
                            datasets: [{
                                data: data,
                                backgroundColor: colors,
                                borderColor: '#1e293b',
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { position: 'bottom', labels: { color: '#94a3b8' } },
                                title: { display: true, text: `Brand Share (Volume) - ${reportMonth}`, color: '#fff' }
                            }
                        }
                    });
                }
            }, [view, salesData, reportMonth]);

            // --- LOGIC ---
            const handleAdd = () => {
                if(!inputBrand || !inputPrice) {
                    toast.addToast("Please select a brand and enter price.", "error");
                    return;
                }
                const qty = parseInt(inputQty) || 1;
                const price = parseInt(inputPrice) || 0;
                setPendingQueue([...pendingQueue, {
                    id: Date.now(),
                    brand: inputBrand,
                    model: inputModel || 'Unknown',
                    variant: inputVariant,
                    price,
                    qty,
                    totalVal: price * qty
                }]);
                setInputModel(''); setInputVariant(''); setInputPrice(''); setInputQty(1);
            };

            const handleSave = () => {
                if(pendingQueue.length === 0) return;
                const newEntry = { ...(salesData[currentDate] || { models: '' }) };
                let logStr = "";
                
                pendingQueue.forEach(item => {
                    const k = item.brand;
                    newEntry[k] = (newEntry[k] || 0) + item.qty;
                    newEntry[`${k}Val`] = (newEntry[`${k}Val`] || 0) + item.totalVal;
                    logStr += `[${new Date().toLocaleTimeString()}] ${brandsList.find(b=>b.key===k)?.label} ${item.model} - ${item.qty} ${item.qty > 1 ? 'units' : 'unit'} (Val: ${item.totalVal})\n`;
                });
                newEntry.models = (newEntry.models || '') + logStr;
                setSalesData({ ...salesData, [currentDate]: newEntry });
                setPendingQueue([]);
                toast.addToast("Saved successfully!", "success");
            };

            const calculateStats = (targetMonthYyyyMm = null) => {
                const monthPrefix = targetMonthYyyyMm || currentDate.slice(0, 7);
                let mtd = { vol: 0, val: 0, breakdownVol: {}, breakdownVal: {} };
                let ftd = { vol: 0, val: 0, breakdownVol: {}, breakdownVal: {} }; // FTD Stats (relative to currentDate)
                
                brandsList.forEach(b => { 
                    mtd.breakdownVol[b.key]=0; mtd.breakdownVal[b.key]=0; 
                    ftd.breakdownVol[b.key]=0; ftd.breakdownVal[b.key]=0; 
                });

                // FTD Calculation (Only relevant for Entry view or if specifically looking at today)
                if(salesData[currentDate]) {
                     brandsList.forEach(b => {
                        const v = Number(salesData[currentDate][b.key]||0); 
                        const va = Number(salesData[currentDate][`${b.key}Val`]||0);
                        ftd.vol += v; ftd.val += va;
                        ftd.breakdownVol[b.key] += v; ftd.breakdownVal[b.key] += va;
                    });
                }

                // MTD Calculation
                Object.keys(salesData).forEach(d => {
                    if(d.startsWith(monthPrefix)) {
                        const rec = salesData[d];
                        brandsList.forEach(b => {
                            const v = Number(rec[b.key]||0); const va = Number(rec[`${b.key}Val`]||0);
                            mtd.vol += v; mtd.val += va; 
                            mtd.breakdownVol[b.key] += v; mtd.breakdownVal[b.key] += va;
                        });
                    }
                });
                return { mtd, ftd };
            };
            
            // Stats used for the current view (Entry uses today, Report uses reportMonth)
            const stats = useMemo(() => calculateStats(view === 'report' || view === 'analytics' ? reportMonth : currentDate.slice(0, 7)), [salesData, currentDate, reportMonth, view]);
            
            // --- EXPORT & IMPORT ---
            const exportData = () => {
                const ws = XLSX.utils.json_to_sheet(
                    Object.entries(salesData).map(([date, data]) => {
                        let row = { Date: date, Log: data.models };
                        brandsList.forEach(b => {
                           row[`${b.label} Qty`] = data[b.key] || 0;
                           row[`${b.label} Val`] = data[`${b.key}Val`] || 0;
                        });
                        return row;
                    })
                );
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Sales Data");
                XLSX.writeFile(wb, "Sales_Export.xlsx");
            };

            const importData = (e) => {
                const file = e.target.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const wb = XLSX.read(evt.target.result, {type:'binary'});
                        const ws = wb.Sheets[wb.SheetNames[0]];
                        const rawData = XLSX.utils.sheet_to_json(ws, {header: 1});
                        
                        // Find header row (contains 'Date' and 'Logs' or 'Samsung Qty')
                        let headerRowIdx = -1;
                        let headers = [];
                        for(let i=0; i<rawData.length; i++) {
                            const r = rawData[i];
                            if(r.includes('Date') && (r.includes('Logs') || r.includes('Log'))) {
                                headerRowIdx = i;
                                headers = r;
                                break;
                            }
                        }

                        if(headerRowIdx === -1) throw new Error("Could not find header row (Date/Logs)");

                        const recovered = {};
                        // Process data rows
                        for(let i=headerRowIdx+1; i<rawData.length; i++) {
                            const row = rawData[i];
                            if(!row || row.length === 0) continue;
                            
                            const getVal = (name) => {
                                const idx = headers.indexOf(name);
                                return idx > -1 ? row[idx] : undefined;
                            };

                            const dateVal = getVal('Date');
                            if(!dateVal) continue;

                            // Handle Excel serial date if necessary, or string date
                            let dateStr = dateVal;
                            // Basic check if it's strictly YYYY-MM-DD or standard format.
                            // If Excel date number:
                            if(typeof dateVal === 'number') {
                                const d = new Date(Math.round((dateVal - 25569)*86400*1000));
                                dateStr = d.toISOString().split('T')[0];
                            }

                            const logVal = getVal('Logs') || getVal('Log') || '';
                            
                            const entry = { models: logVal };
                            brandsList.forEach(b => {
                                const q = getVal(`${b.label} Qty`);
                                const v = getVal(`${b.label} Value`) || getVal(`${b.label} Val`);
                                if(q) entry[b.key] = Number(q);
                                if(v) entry[`${b.key}Val`] = Number(v);
                            });
                            recovered[dateStr] = entry;
                        }
                        
                        const count = Object.keys(recovered).length;
                        confirm({
                            title: "Overwrite Data?",
                            message: `Found ${count} days of data. This will overwrite existing data. Continue?`,
                            isDanger: true,
                            onConfirm: () => {
                                setSalesData(recovered);
                                // Auto-set to latest date
                                const dates = Object.keys(recovered).sort();
                                if(dates.length > 0) {
                                    const lastDate = dates[dates.length - 1];
                                    setCurrentDate(lastDate);
                                    setReportMonth(lastDate.slice(0, 7));
                                }
                                toast.addToast("Import Successful!", "success");
                            }
                        });
                    } catch(err) {
                        console.error(err);
                        toast.addToast("Failed to parse file. Ensure it is a valid Sales Tracker Export or Elite Report.", "error");
                    }
                };
                reader.readAsBinaryString(file);
            };

            return (
                <div className="animate-fade-in pb-20">
                    {/* Toolbar */}
                    <div className="flex justify-between items-center mb-6">
                        <div className="flex gap-2 overflow-x-auto no-scrollbar py-2">
                            {['entry', 'report', 'analytics', 'profile'].map(v => (
                                <button 
                                    key={v}
                                    onClick={() => setView(v)}
                                    className={`px-4 py-2 rounded-xl text-xs font-bold uppercase tracking-wider whitespace-nowrap transition-all ${view === v ? 'bg-brand-600 text-white shadow-lg shadow-brand-500/20' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}
                                >
                                    {v}
                                </button>
                            ))}
                        </div>
                        <button onClick={() => setShowImportExport(true)} className="p-2 bg-slate-800 text-slate-300 rounded-lg hover:bg-slate-700">
                            <LucideIcon name="database" size={20} />
                        </button>
                    </div>

                     <Modal isOpen={showImportExport} onClose={() => setShowImportExport(false)} title="Data Management">
                        <div className="space-y-6">
                            <div className="bg-slate-800/50 p-4 rounded-xl border border-slate-700">
                                <h4 className="font-bold text-white mb-2 flex items-center gap-2"><LucideIcon name="download" size={16}/> Export Data</h4>
                                <p className="text-xs text-slate-400 mb-4">Download all your sales data as an Excel file for backup or reporting.</p>
                                <Button onClick={exportData} variant="secondary" className="w-full">Export to Excel</Button>
                            </div>
                            
                            <div className="bg-slate-800/50 p-4 rounded-xl border border-slate-700">
                                <h4 className="font-bold text-white mb-2 flex items-center gap-2"><LucideIcon name="upload" size={16}/> Import Backup</h4>
                                <p className="text-xs text-slate-400 mb-4">Restore data from a previously exported Excel file. <span className="text-red-400">Warning: This may overwrite existing data.</span></p>
                                <div className="relative">
                                    <input type="file" id="tracker-import-modal" className="hidden" accept=".xlsx" onChange={importData} />
                                    <label htmlFor="tracker-import-modal" className="flex items-center justify-center gap-2 w-full px-4 py-3 rounded-xl font-bold text-sm bg-brand-600 text-white shadow-lg shadow-brand-500/20 hover:bg-brand-500 cursor-pointer transition-all">
                                        Select File to Import
                                    </label>
                                </div>
                            </div>
                            <Button onClick={() => setShowImportExport(false)} variant="outline" className="w-full">Close</Button>
                        </div>
                    </Modal>

                    {/* VIEW: ENTRY */}
                    {view === 'entry' && (
                        <div className="space-y-6">
                             <Card>
                                <div className="flex justify-between items-center mb-4">
                                    <div className="flex items-center gap-2">
                                        <LucideIcon name="calendar" className="text-brand-400" />
                                        <input type="date" value={currentDate} onChange={(e)=>setCurrentDate(e.target.value)} className="bg-transparent text-white font-bold outline-none" />
                                    </div>
                                    <button onClick={()=>setPendingQueue([])} className="text-xs text-red-400 hover:text-red-300">Clear Queue</button>
                                </div>
                                
                                <div className="grid grid-cols-1 gap-3 mb-3">
                                    <select value={inputBrand} onChange={(e)=>setInputBrand(e.target.value)} className="w-full h-12 px-4 rounded-xl bg-slate-900 border border-slate-700 text-white font-bold">
                                        <option value="">Select Brand</option>
                                        {brandsList.map(b => <option key={b.key} value={b.key}>{b.label}</option>)}
                                    </select>
                                    <Input placeholder="Model (e.g. S24)" value={inputModel} onChange={(e)=>setInputModel(e.target.value)} />
                                    <div className="grid grid-cols-2 gap-3">
                                        <Input type="number" placeholder="Price" value={inputPrice} onChange={(e)=>setInputPrice(e.target.value)} />
                                        <Input type="number" placeholder="Qty" value={inputQty} onChange={(e)=>setInputQty(e.target.value)} />
                                    </div>
                                </div>
                                <Button onClick={handleAdd} className="w-full" icon="plus">Add to Queue</Button>
                            </Card>

                            {pendingQueue.length > 0 && (
                                <div className="bg-slate-800 rounded-2xl p-4 animate-fade-in-up">
                                    <h4 className="font-bold text-slate-300 mb-3 text-sm">Pending Save ({pendingQueue.length})</h4>
                                    <div className="space-y-2 mb-4">
                                        {pendingQueue.map((item, i) => (
                                            <div key={i} className="flex justify-between text-xs p-2 bg-slate-700/50 rounded-lg">
                                                <span className="text-slate-200">{item.brand} {item.model} x{item.qty}</span>
                                                <span className="font-bold text-emerald-400">â‚¹{item.totalVal}</span>
                                            </div>
                                        ))}
                                    </div>
                                    <Button onClick={handleSave} variant="primary" className="w-full" icon="save">Save to {currentDate}</Button>
                                </div>
                            )}

                             {salesData[currentDate]?.models && (
                                <Card className="border-l-4 border-l-brand-500">
                                    <h4 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Today's Log</h4>
                                    <pre className="text-xs text-slate-500 font-mono whitespace-pre-wrap">{salesData[currentDate].models}</pre>
                                </Card>
                            )}
                        </div>
                    )}

                    {/* VIEW: REPORT */}
                    {view === 'report' && (
                        <div className="space-y-6">
                            <div className="flex items-center justify-between bg-slate-800/50 p-3 rounded-xl border border-slate-700">
                                <span className="text-xs font-bold text-slate-400 uppercase tracking-wider">Report Month</span>
                                <input 
                                    type="month" 
                                    value={reportMonth} 
                                    onChange={(e)=>setReportMonth(e.target.value)} 
                                    className="bg-transparent text-white font-bold outline-none text-right"
                                />
                            </div>

                            {/* FTD Card - New Addition */}
                            <Card className="bg-gradient-to-br from-indigo-900 to-slate-900 border-indigo-500/30">
                                <div className="flex justify-between items-start">
                                    <div>
                                        <div className="text-xs font-bold text-indigo-400 uppercase tracking-wider mb-1">FTD Volume (Today)</div>
                                        <div className="text-4xl font-bold text-white">{stats.ftd.vol} <span className="text-lg text-slate-500 font-medium">units</span></div>
                                    </div>
                                    <div className="text-right">
                                        <div className="text-xs font-bold text-emerald-400 uppercase tracking-wider mb-1">FTD Value</div>
                                        <div className="text-2xl font-bold text-white">â‚¹{(stats.ftd.val / 1000).toFixed(1)}k</div>
                                    </div>
                                </div>
                            </Card>

                            {/* MTD Card */}
                            <Card className="bg-gradient-to-br from-brand-900 to-slate-900">
                                <div className="flex justify-between items-start mb-6">
                                    <div>
                                        <div className="text-xs font-bold text-brand-400 uppercase tracking-wider mb-1">MTD Volume ({reportMonth})</div>
                                        <div className="text-4xl font-bold text-white">{stats.mtd.vol} <span className="text-lg text-slate-500 font-medium">units</span></div>
                                    </div>
                                    <div className="text-right">
                                        <div className="text-xs font-bold text-emerald-400 uppercase tracking-wider mb-1">MTD Value</div>
                                        <div className="text-2xl font-bold text-white">â‚¹{(stats.mtd.val / 1000).toFixed(1)}k</div>
                                    </div>
                                </div>
                            </Card>

                            <Card>
                                <h3 className="font-bold text-white mb-4">Month Breakdown</h3>
                                <div className="space-y-3">
                                    {brandsList.map(b => (
                                        <div key={b.key} className="flex items-center justify-between p-2 hover:bg-slate-800/50 rounded-lg transition-colors">
                                            <div className="flex items-center gap-3">
                                                <div className="w-2 h-8 rounded-full" style={{backgroundColor: b.color}}></div>
                                                <span className="font-medium text-slate-300">{b.label}</span>
                                            </div>
                                            <div className="text-right">
                                                <div className="font-bold text-white">{stats.mtd.breakdownVol[b.key]} <span className="text-xs text-slate-500">units</span></div>
                                                <div className="text-xs text-slate-500">â‚¹{(stats.mtd.breakdownVal[b.key]/1000).toFixed(1)}k</div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </Card>
                        </div>
                    )}

                    {/* VIEW: ANALYTICS */}
                    {view === 'analytics' && (
                        <div className="space-y-6">
                            <div className="flex items-center justify-between bg-slate-800/50 p-3 rounded-xl border border-slate-700">
                                <span className="text-xs font-bold text-slate-400 uppercase tracking-wider">Analysis Month</span>
                                <input 
                                    type="month" 
                                    value={reportMonth} 
                                    onChange={(e)=>setReportMonth(e.target.value)} 
                                    className="bg-transparent text-white font-bold outline-none text-right"
                                />
                            </div>
                            <Card>
                                <canvas ref={chartRef} id="brandChart"></canvas>
                            </Card>
                            <Card>
                                <h3 className="font-bold text-white mb-4">Performance Insights</h3>
                                <div className="space-y-4">
                                    <div>
                                        <div className="flex justify-between text-sm mb-1">
                                            <span className="text-slate-400">Volume Target</span>
                                            <span className="text-white font-bold">{stats.mtd.vol} / {profile.targetVol || '-'}</span>
                                        </div>
                                        <div className="h-1.5 bg-slate-800 rounded-full">
                                            <div className="h-full bg-blue-500 rounded-full" style={{width: `${Math.min((stats.mtd.vol/(profile.targetVol||1))*100, 100)}%`}}></div>
                                        </div>
                                    </div>
                                    <div>
                                        <div className="flex justify-between text-sm mb-1">
                                            <span className="text-slate-400">Value Target</span>
                                            <span className="text-white font-bold">{(stats.mtd.val/1000).toFixed(0)}k / {profile.targetVal ? (profile.targetVal/1000).toFixed(0)+'k' : '-'}</span>
                                        </div>
                                        <div className="h-1.5 bg-slate-800 rounded-full">
                                            <div className="h-full bg-emerald-500 rounded-full" style={{width: `${Math.min((stats.mtd.val/(profile.targetVal||1))*100, 100)}%`}}></div>
                                        </div>
                                    </div>
                                </div>
                            </Card>
                        </div>
                    )}

                    {/* VIEW: PROFILE */}
                    {view === 'profile' && (
                        <div className="space-y-6">
                            <Card>
                                <div className="text-center mb-6">
                                    <div className="w-20 h-20 bg-slate-800 rounded-full mx-auto flex items-center justify-center mb-3">
                                        <LucideIcon name="user" size={32} className="text-slate-500" />
                                    </div>
                                    <h3 className="font-bold text-white text-lg">Profile Settings</h3>
                                </div>
                                <div className="space-y-4">
                                    <Input label="Name" value={profile.name} onChange={(e)=>setProfile({...profile, name: e.target.value})} />
                                    <Input label="Outlet Name" value={profile.outlet} onChange={(e)=>setProfile({...profile, outlet: e.target.value})} />
                                    <div className="grid grid-cols-2 gap-4">
                                        <Input label="Target Vol" type="number" value={profile.targetVol} onChange={(e)=>setProfile({...profile, targetVol: e.target.value})} />
                                        <Input label="Target Val (â‚¹)" type="number" value={profile.targetVal} onChange={(e)=>setProfile({...profile, targetVal: e.target.value})} />
                                    </div>
                                </div>
                                <div className="mt-6 p-3 bg-blue-500/10 border border-blue-500/20 rounded-xl text-xs text-blue-400">
                                    Targets are used to calculate achievement percentages in Reports and Analytics.
                                </div>
                            </Card>
                        </div>
                    )}
                </div>
            );
        };
        const IncentiveCalculator = () => {
            const [rows, setRows] = useState({ sp: [], tb: [], wr: [], cp: [], npc: [], bun: [] });
            const [settings, setSettings] = useState({ channel: 'standard', status: 'existing', enforceGates: false });
            const toast = useToast();
            const confirm = useConfirm();
            
            // Default Config (Hardcoded from v15 logic)
            const DEFAULTS = {
                sp: {
                    slabs: [{min: 100000, rate: 700, label: ">= 100k"}, {min: 70000, rate: 600, label: "70k - 100k"}, {min: 40000, rate: 500, label: "40k - 70k"}, {min: 30000, rate: 300, label: "30k - 40k"}, {min: 20000, rate: 200, label: "20k - 30k"}, {min: 15000, rate: 100, label: "15k - 20k"}, {min: 10000, rate: 75, label: "10k - 15k"}, {min: 0, rate: 25, label: "< 10k"}],
                    gates: { std: [{min: 40, p: 1.0}, {min: 35, p: 0.75}, {min: 30, p: 0.6}], sis: [{min: 40, p: 1.0}, {min: 35, p: 1.0}, {min: 30, p: 0.75}, {min: 25, p: 0.5}] },
                    fm_mult: 0.5, target_thresh: 0.8
                },
                tb: { slabs: [{min:70000,rate:800},{min:40000,rate:600},{min:30000,rate:500},{min:20000,rate:300},{min:15000,rate:200},{min:10000,rate:100}], focus: [{name:"S11 Ultra", rate:1500}, {name:"S11/S10+", rate:1000}, {name:"S10 Lite", rate:750}, {name:"A11 Plus", rate:400}] },
                wr: [{name:"Watch Ultra / 8 Cls", rate:1200}, {name:"Other Watches", rate:800}, {name:"Buds3 Pro", rate:600}, {name:"Buds3 / FE", rate:500}, {name:"Other Buds", rate:400}, {name:"Ring", rate:0}],
                cp: { slabs: [{min:100000,rate:400},{min:70000,rate:350},{min:40000,rate:300},{min:30000,rate:200},{min:20000,rate:120},{min:10000,rate:100},{min:0,rate:50}], kickers: { ff7:{l:400,h:600}, s25:{l:300,h:500} } },
                npc: [{name:"GB5 Pro", rate:3000}, {name:"GB5 360", rate:2500}, {name:"GB5", rate:1750}, {name:"GB4 Edge", rate:1250}],
                bun: { std: [{name:"Wr+Hr", rate:750}, {name:"Wearable", rate:400}, {name:"Hearable", rate:250}], excl: [{name:"Wr+Hr+Acc", rate:1000}, {name:"Wr+Hr", rate:750}, {name:"Wearable", rate:400}, {name:"Hearable", rate:250}, {name:"Acc", rate:100}] },
                acc: [{min:4, rate:3000}, {min:3, rate:2000}, {min:2, rate:1000}, {min:1, rate:500}],
                caps: { global:75000, tb:20000, npc:50000, bun:10000 }
            };

            const [config, setConfig] = useState(() => {
                const s = localStorage.getItem('sec_incentive_config');
                return s ? JSON.parse(s) : DEFAULTS;
            });

            useEffect(() => { localStorage.setItem('sec_incentive_config', JSON.stringify(config)); }, [config]);

            const [extra, setExtra] = useState({
                accVal: 0, accBase: 0,
                k_ff7: 0, t_ff7: 'low',
                k_s25: 0, t_s25: 'low'
            });

            const [result, setResult] = useState({ total: 0, logs: [] });
            const [showConfig, setShowConfig] = useState(false);

            // --- CALCULATION LOGIC ---
            const calculateIncentive = () => {
                let logs = [];
                let total = 0;
                const c = config;
                const chan = settings.channel;
                const isExempt = (chan === 'sis_pro' || settings.status === 'new_joinee');

                // 1. SP
                let spQ = 0, spRaw = 0;
                rows.sp.forEach(r => {
                    if(r.qty > 0) { spQ += r.qty; spRaw += r.qty * (r.fm ? r.rate * c.sp.fm_mult : r.rate); }
                });
                
                const gateSet = isExempt ? c.sp.gates.sis : c.sp.gates.std;
                let gateM = 0, gateN = "Missed Gate";
                for(let g of gateSet) { if(spQ >= g.min) { gateM = g.p; gateN = ""; break; } }
                
                let spFin = spRaw * gateM;
                
                if (gateM === 0) {
                    if (settings.enforceGates) {
                        gateN = `Missed Vol Gate (${spQ}) - Zeroed`;
                        spFin = 0; 
                    } else {
                        gateN = `Missed Vol Gate (${spQ}) - Ignored`;
                        spFin = spRaw;
                    }
                }

                logs.push({ cat: "Smartphones", note: gateN, val: spFin, raw: spRaw });
                total += spFin;

                // 2. TB
                let tbTot = 0, a11 = 0;
                rows.tb.forEach(r => {
                    if(r.qty > 0) {
                        if(r.type === 'a11') a11 += r.qty;
                        else tbTot += r.qty * r.rate;
                    }
                });
                if(a11>=3) tbTot+=a11*400; else if(a11===2) tbTot+=a11*300; else if(a11===1) tbTot+=a11*250;
                const tbFin = Math.min(tbTot, c.caps.tb);
                logs.push({ cat: "Tablets", note: tbTot>tbFin?"Capped":"", val: tbFin });
                total += tbFin;

                // 3. WR
                let wrTot = 0, ring = 0;
                rows.wr.forEach(r => {
                    if(r.qty > 0) {
                        if(c.wr[r.idx]?.name.toLowerCase().includes('ring')) ring += r.qty;
                        else wrTot += r.qty * c.wr[r.idx]?.rate;
                    }
                });
                if(ring>=3) wrTot+=5000; else if(ring===2) wrTot+=4000; else if(ring===1) wrTot+=3000;
                logs.push({ cat: "Wearables", note: "", val: wrTot });
                total += wrTot;

                // 4. Global Cap Check
                let comb = spFin + wrTot;
                if(comb > c.caps.global) {
                    const capAdj = c.caps.global - comb; 
                    logs.push({ cat: "Global Cap Adj", note: "Max 75k", val: capAdj });
                    total += capAdj; // negative
                }

                // 5. CP
                let cpTot = 0, cpQ = 0;
                rows.cp.forEach(r => { if(r.qty > 0) { cpQ += r.qty; cpTot += r.qty * r.rate; } });
                if(cpQ >= 8) cpTot *= 1.2;
                if(cpQ > 0 && cpQ < 3) { cpTot = 0; logs.push({ cat: "Care+", note: "Gate < 3", val: 0 }); }
                else {
                    if(extra.k_ff7 > 0) cpTot += extra.k_ff7 * (extra.t_ff7 === 'high' ? c.cp.kickers.ff7.h : c.cp.kickers.ff7.l);
                    if(extra.k_s25 > 0) cpTot += extra.k_s25 * (extra.t_s25 === 'high' ? c.cp.kickers.s25.h : c.cp.kickers.s25.l);
                    logs.push({ cat: "Care+", note: "", val: cpTot });
                    total += cpTot;
                }

                // 6. NPC
                let npcTot = 0;
                rows.npc.forEach(r => { npcTot += r.qty * r.rate; });
                const npcFin = Math.min(npcTot, c.caps.npc);
                logs.push({ cat: "Note PC", note: npcTot>npcFin?"Capped":"", val: npcFin });
                total += npcFin;

                // 7. Bundles
                let bunTot = 0;
                const bunList = (chan === 'exclusive') ? c.bun.excl : c.bun.std;
                Object.keys(rows.bun).forEach(k => {
                    const qty = rows.bun[k] || 0;
                    if(bunList[k]) bunTot += qty * bunList[k].rate;
                });
                if(chan !== 'exclusive') bunTot = Math.min(bunTot, c.caps.bun);
                logs.push({ cat: "Bundles", note: "", val: bunTot });
                total += bunTot;

                // 8. Acc
                let accTot = 0;
                const ab = extra.accBase || (spRaw * 25);
                if(ab > 0 && chan !== 'exclusive') {
                    const pct = (extra.accVal / ab) * 100;
                    for(let t of c.acc) { if(pct >= t.min) { accTot = t.rate; break; } }
                }
                logs.push({ cat: "Accessories", note: `Ach: ${((extra.accVal/ab)*100).toFixed(1)}%`, val: accTot });
                total += accTot;

                setResult({ total, logs });
            };

            // Auto-calculate on changes
            useEffect(() => {
                calculateIncentive();
            }, [rows, settings, extra, config]);


            // --- HANDLERS ---
            const addRow = (type, data = {}) => {
                setRows(prev => {
                    const newRow = { id: Date.now(), qty: 1, ...data };
                    // Set defaults based on type
                    if(type === 'sp') newRow.rate = config.sp.slabs[0].rate;
                    if(type === 'tb') { newRow.type = 'f'; newRow.rate = config.tb.focus[0].rate; }
                    if(type === 'cp') newRow.rate = config.cp.slabs[0].rate;
                    if(type === 'npc') newRow.rate = config.npc[0].rate;
                    if(type === 'wr') { newRow.idx = 0; }
                    return { ...prev, [type]: [...prev[type], newRow] };
                });
            };

            const updateRow = (type, id, field, val) => {
                setRows(prev => ({
                    ...prev,
                    [type]: prev[type].map(r => r.id === id ? { ...r, [field]: val } : r)
                }));
            };

            const delRow = (type, id) => {
                setRows(prev => ({ ...prev, [type]: prev[type].filter(r => r.id !== id) }));
            };
            
            const clearAll = () => {
                confirm({
                    title: "Clear All Entries?",
                    message: "This will remove all entered data. Are you sure?",
                    isDanger: true,
                    onConfirm: () => {
                        setRows({ sp: [], tb: [], wr: [], cp: [], npc: [], bun: [] });
                        setExtra({ accVal: 0, accBase: 0, k_ff7: 0, t_ff7: 'low', k_s25: 0, t_s25: 'low' });
                        toast.addToast("Cleared all entries.", "info");
                    }
                });
            };

            const exportExcel = () => {
                const data = result.logs.map(l => ({ Category: l.cat, Note: l.note, Amount: l.val }));
                data.push({ Category: "TOTAL", Note: "", Amount: result.total });
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Incentive Calc");
                XLSX.writeFile(wb, "Incentive_Breakdown.xlsx");
            };

            const importFromTracker = (e) => {
                const file = e.target.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const wb = XLSX.read(evt.target.result, {type:'binary'});
                        const ws = wb.Sheets[wb.SheetNames[0]];
                        const rawData = XLSX.utils.sheet_to_json(ws, {header: 1});

                        // Find header row (contains 'Date' and 'Logs' or 'Samsung Qty')
                        let headerRowIdx = -1;
                        let headers = [];
                        for(let i=0; i<rawData.length; i++) {
                            const r = rawData[i];
                            // More robust check for header
                            const strR = JSON.stringify(r).toLowerCase();
                            if(strR.includes('date') && (strR.includes('log') || strR.includes('model') || strR.includes('details'))) {
                                headerRowIdx = i;
                                headers = r;
                                break;
                            }
                        }

                        if(headerRowIdx === -1) throw new Error("Could not find header row (Date/Logs)");
                        
                        const newRows = { sp: [], tb: [], wr: [], cp: [], npc: [], bun: {} };
                        let count = 0;
                        
                        for(let i=headerRowIdx+1; i<rawData.length; i++) {
                            const row = rawData[i];
                            if(!row || row.length === 0) continue;

                            // Skip if no date or invalid date row
                            const idxDate = headers.indexOf('Date');
                            if(idxDate > -1 && !row[idxDate]) continue;

                            // Find the log column index dynamically
                            let idxLog = -1;
                            headers.forEach((h, idx) => {
                                if(h && typeof h === 'string' && ['logs', 'log', 'model', 'details', 'description'].includes(h.toLowerCase())) {
                                    idxLog = idx;
                                }
                            });
                            
                            if(idxLog === -1) continue;

                            const logTxt = row[idxLog];
                            if(!logTxt) continue;

                            const lines = logTxt.split('\n');
                            lines.forEach(line => {
                                // Enhanced Regex: matches [HH:MM] Brand Model - Qty unit (Val: Value)
                                // Case insensitive, spaces tolerant
                                const regex = /\[.*?\]\s+(.*?)\s+(.*?)\s+-\s+(\d+)\s*units?\s+\(Val(?:ue)?:\s+(\d+)\)/i;
                                const match = line.match(regex);
                                if(match) {
                                    const brand = match[1].toLowerCase();
                                    const model = match[2];
                                    const qty = parseInt(match[3]);
                                    const val = parseInt(match[4]);
                                    const unitPrice = val / qty;
                                    
                                    if(brand.includes('samsung')) {
                                        count++;
                                        const mLower = model.toLowerCase();
                                        const id = Date.now() + Math.random();
                                        
                                        if(mLower.includes('care') || mLower.includes('protect')) {
                                            const slab = config.cp.slabs.find(s => unitPrice >= s.min) || config.cp.slabs[config.cp.slabs.length-1];
                                            newRows.cp.push({ id, qty, rate: slab.rate, type: 's' });
                                        } else if (mLower.includes('tab')) {
                                            const focus = config.tb.focus.find(f => mLower.includes(f.name.toLowerCase()));
                                            if(focus) {
                                                newRows.tb.push({ id, qty, rate: focus.rate, type: 'f' });
                                            } else {
                                                const slab = config.tb.slabs.find(s => unitPrice >= s.min) || config.tb.slabs[config.tb.slabs.length-1];
                                                newRows.tb.push({ id, qty, rate: slab.rate, type: 's' });
                                            }
                                        } else if (mLower.includes('watch') || mLower.includes('buds') || mLower.includes('ring')) {
                                            let bestIdx = 1; 
                                            config.wr.forEach((w, idx) => {
                                                if(mLower.includes('ultra') && w.name.toLowerCase().includes('ultra')) bestIdx = idx;
                                                else if(mLower.includes('buds') && w.name.toLowerCase().includes('buds')) bestIdx = idx;
                                            });
                                            newRows.wr.push({ id, qty, idx: bestIdx });
                                        } else {
                                            const slab = config.sp.slabs.find(s => unitPrice >= s.min) || config.sp.slabs[config.sp.slabs.length-1];
                                            newRows.sp.push({ id, qty, rate: slab.rate, fm: false });
                                        }
                                    }
                                }
                            });
                        }
                        
                        if(count > 0) {
                            confirm({
                                title: "Load Data?",
                                message: `Found ${count} Samsung items. Load into calculator?`,
                                onConfirm: () => {
                                    setRows(prev => ({ ...prev, ...newRows }));
                                    toast.addToast(`Loaded ${count} items.`, "success");
                                }
                            });
                        } else {
                            toast.addToast("No Samsung sales found in the log.", "warning");
                        }
                    } catch(e) {
                        console.error(e);
                        toast.addToast("Error parsing file.", "error");
                    }
                };
                reader.readAsBinaryString(file);
            };

            return (
                <div className="pb-24 animate-fade-in space-y-6">
                    {/* Header / Summary */}
                    <div className="bg-gradient-to-r from-emerald-900 to-slate-900 p-6 rounded-3xl border border-emerald-500/30 shadow-lg relative overflow-hidden">
                         <div className="relative z-10 flex justify-between items-center">
                            <div>
                                <h2 className="text-3xl font-bold text-white mb-1">â‚¹{Math.floor(result.total).toLocaleString()}</h2>
                                <p className="text-emerald-400 text-sm font-bold uppercase tracking-wider">Estimated Payout</p>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={calculateIncentive} className="px-4 py-3 bg-white text-emerald-900 font-bold rounded-xl shadow-lg hover:bg-emerald-50 transition-all flex items-center gap-2">
                                    <LucideIcon name="calculator" size={18} /> Calculate
                                </button>
                                <button onClick={clearAll} className="p-3 bg-red-500/10 hover:bg-red-500/20 text-red-400 rounded-xl transition-colors" title="Clear All"><LucideIcon name="trash-2" /></button>
                                <div className="relative">
                                    <input type="file" id="inc-upload" className="hidden" accept=".xlsx" onChange={importFromTracker} />
                                    <label htmlFor="inc-upload" className="flex items-center justify-center p-3 bg-white/10 hover:bg-white/20 rounded-xl text-white transition-colors cursor-pointer" title="Import from Tracker">
                                        <LucideIcon name="upload-cloud" />
                                    </label>
                                </div>
                                <button onClick={exportExcel} className="p-3 bg-white/10 hover:bg-white/20 rounded-xl text-white transition-colors" title="Export Result"><LucideIcon name="download" /></button>
                                <button onClick={() => setShowConfig(true)} className="p-3 bg-white/10 hover:bg-white/20 rounded-xl text-white transition-colors" title="Settings"><LucideIcon name="settings" /></button>
                            </div>
                         </div>
                         {/* Breakdown Toggle/View */}
                         <div className="relative z-10 mt-4 pt-4 border-t border-white/10">
                            <div className="space-y-2">
                                {result.logs.map((l, i) => (
                                    <div key={i} className="flex justify-between items-center text-xs">
                                        <span className="text-slate-300">{l.cat}</span>
                                        <div className="text-right">
                                            <span className={`font-bold ${l.val > 0 ? 'text-white' : 'text-slate-500'}`}>â‚¹{Math.floor(l.val).toLocaleString()}</span>
                                            {l.note && <span className="block text-[10px] text-red-400">{l.note}</span>}
                                        </div>
                                    </div>
                                ))}
                            </div>
                         </div>
                    </div>

                    {/* Settings Bar */}
                    <Card>
                        <div className="grid grid-cols-3 gap-4">
                             <div>
                                <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Channel</label>
                                <select className="w-full bg-slate-800 text-white text-xs p-2 rounded-lg mt-1 outline-none" value={settings.channel} onChange={e=>setSettings({...settings, channel: e.target.value})}>
                                    <option value="standard">Standard</option>
                                    <option value="sis_pro">SIS Pro</option>
                                    <option value="exclusive">Exclusive</option>
                                </select>
                            </div>
                            <div>
                                <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Status</label>
                                <select className="w-full bg-slate-800 text-white text-xs p-2 rounded-lg mt-1 outline-none" value={settings.status} onChange={e=>setSettings({...settings, status: e.target.value})}>
                                    <option value="existing">Existing</option>
                                    <option value="new_joinee">New Joinee</option>
                                </select>
                            </div>
                            <div>
                                <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Strict Mode</label>
                                <div className="flex items-center gap-2 mt-2">
                                    <input 
                                        type="checkbox" 
                                        className="w-4 h-4 rounded bg-slate-800 border-slate-600"
                                        checked={settings.enforceGates} 
                                        onChange={e=>setSettings({...settings, enforceGates: e.target.checked})}
                                    />
                                    <span className="text-xs text-white">Enforce Gates</span>
                                </div>
                            </div>
                        </div>
                    </Card>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {/* 1. SMARTPHONES */}
                        <Card className="border-l-4 border-l-blue-500">
                            <div className="flex justify-between mb-4">
                                <h3 className="font-bold text-white flex items-center gap-2"><LucideIcon name="smartphone" size={18} className="text-blue-400"/> Smartphones</h3>
                                <button onClick={() => addRow('sp')} className="text-xs bg-blue-500/20 text-blue-400 px-2 py-1 rounded hover:bg-blue-500/30">+ Add</button>
                            </div>
                            <div className="space-y-2">
                                {rows.sp.map(r => (
                                    <div key={r.id} className="flex gap-2 items-center">
                                        <select className="bg-slate-800 text-white text-xs p-2 rounded flex-1 min-w-0" value={r.rate} onChange={e=>updateRow('sp', r.id, 'rate', Number(e.target.value))}>
                                            {config.sp.slabs.map((s,i) => <option key={i} value={s.rate}>{s.label || `>=${s.min}`} (â‚¹{s.rate})</option>)}
                                        </select>
                                        <input type="number" className="bg-slate-800 text-white text-xs p-2 rounded w-12 text-center shrink-0" value={r.qty} onChange={e=>updateRow('sp', r.id, 'qty', Number(e.target.value))} />
                                        <div className="flex items-center gap-1 bg-slate-800 p-1.5 rounded shrink-0">
                                            <input type="checkbox" checked={r.fm} onChange={e=>updateRow('sp', r.id, 'fm', e.target.checked)} />
                                            <span className="text-[10px] font-bold text-slate-400">FM</span>
                                        </div>
                                        <button onClick={()=>delRow('sp', r.id)} className="text-red-400 p-1 hover:bg-slate-800 rounded shrink-0"><LucideIcon name="trash" size={16}/></button>
                                    </div>
                                ))}
                            </div>
                        </Card>

                        {/* 2. TABLETS */}
                        <Card className="border-l-4 border-l-emerald-500">
                            <div className="flex justify-between mb-4">
                                <h3 className="font-bold text-white flex items-center gap-2"><LucideIcon name="tablet" size={18} className="text-emerald-400"/> Tablets</h3>
                                <button onClick={() => addRow('tb')} className="text-xs bg-emerald-500/20 text-emerald-400 px-2 py-1 rounded hover:bg-emerald-500/30">+ Add</button>
                            </div>
                             <div className="space-y-2">
                                {rows.tb.map(r => (
                                    <div key={r.id} className="flex gap-2 items-center">
                                        <select className="bg-slate-800 text-white text-xs p-2 rounded flex-1 min-w-0" value={r.rate} onChange={e=>{
                                            const v = Number(e.target.value);
                                            const t = e.target.selectedOptions[0].dataset.type;
                                            updateRow('tb', r.id, 'rate', v);
                                            updateRow('tb', r.id, 'type', t);
                                        }}>
                                            <optgroup label="Focus">
                                                {config.tb.focus.map((f,i) => <option key={`f${i}`} value={f.rate} data-type="f">{f.name} ({f.rate})</option>)}
                                            </optgroup>
                                            <option value="0" data-type="a11">A11 Tiered</option>
                                            <optgroup label="Slabs">
                                                {config.tb.slabs.map((s,i) => <option key={`s${i}`} value={s.rate} data-type="s">{s.label || `>=${s.min}`} ({s.rate})</option>)}
                                            </optgroup>
                                        </select>
                                        <input type="number" className="bg-slate-800 text-white text-xs p-2 rounded w-12 text-center shrink-0" value={r.qty} onChange={e=>updateRow('cp', r.id, 'qty', Number(e.target.value))} />
                                        <button onClick={()=>delRow('cp', r.id)} className="text-red-400 p-1 hover:bg-slate-800 rounded shrink-0"><LucideIcon name="trash" size={16}/></button>
                                    </div>
                                ))}
                            </div>
                        </Card>

                        {/* 3. WEARABLES */}
                        <Card className="border-l-4 border-l-purple-500">
                            <div className="flex justify-between mb-4">
                                <h3 className="font-bold text-white flex items-center gap-2"><LucideIcon name="watch" size={18} className="text-purple-400"/> Wearables</h3>
                                <button onClick={() => addRow('wr')} className="text-xs bg-purple-500/20 text-purple-400 px-2 py-1 rounded hover:bg-purple-500/30">+ Add</button>
                            </div>
                            <div className="space-y-2">
                                {rows.wr.map(r => (
                                    <div key={r.id} className="flex gap-2 items-center">
                                        <select className="bg-slate-800 text-white text-xs p-2 rounded w-full" value={r.idx} onChange={e=>updateRow('wr', r.id, 'idx', Number(e.target.value))}>
                                            {config.wr.map((w,i) => <option key={i} value={i}>{w.name} ({w.rate})</option>)}
                                        </select>
                                        <input type="number" className="bg-slate-800 text-white text-xs p-2 rounded w-16 text-center" value={r.qty} onChange={e=>updateRow('wr', r.id, 'qty', Number(e.target.value))} />
                                        <button onClick={()=>delRow('wr', r.id)} className="text-red-400"><LucideIcon name="trash" size={14}/></button>
                                    </div>
                                ))}
                            </div>
                        </Card>

                        {/* 4. CARE+ & KICKERS */}
                         <Card className="border-l-4 border-l-red-500">
                            <div className="flex justify-between mb-4">
                                <h3 className="font-bold text-white flex items-center gap-2"><LucideIcon name="shield" size={18} className="text-red-400"/> Care+ & Kickers</h3>
                                <button onClick={() => addRow('cp')} className="text-xs bg-red-500/20 text-red-400 px-2 py-1 rounded hover:bg-red-500/30">+ Add</button>
                            </div>
                            <div className="space-y-2 mb-4">
                                {rows.cp.map(r => (
                                    <div key={r.id} className="flex gap-2 items-center">
                                        <select className="bg-slate-800 text-white text-xs p-2 rounded w-full" value={r.rate} onChange={e=>updateRow('cp', r.id, 'rate', Number(e.target.value))}>
                                            {config.cp.slabs.map((s,i) => <option key={i} value={s.rate}>{s.label || `>=${s.min}`} (â‚¹{s.rate})</option>)}
                                        </select>
                                        <input type="number" className="bg-slate-800 text-white text-xs p-2 rounded w-16 text-center" value={r.qty} onChange={e=>updateRow('cp', r.id, 'qty', Number(e.target.value))} />
                                        <button onClick={()=>delRow('cp', r.id)} className="text-red-400"><LucideIcon name="trash" size={14}/></button>
                                    </div>
                                ))}
                            </div>
                            <div className="grid grid-cols-2 gap-2 text-xs">
                                <div className="bg-slate-800 p-2 rounded">
                                    <span className="block text-slate-400 mb-1">FF7 Kicker</span>
                                    <div className="flex gap-1">
                                        <input type="number" placeholder="Qty" className="w-full bg-slate-700 p-1 rounded text-white" value={extra.k_ff7} onChange={e=>setExtra({...extra, k_ff7: Number(e.target.value)})} />
                                        <select className="bg-slate-700 text-white rounded" value={extra.t_ff7} onChange={e=>setExtra({...extra, t_ff7: e.target.value})}><option value="low">Low</option><option value="high">High</option></select>
                                    </div>
                                </div>
                                <div className="bg-slate-800 p-2 rounded">
                                    <span className="block text-slate-400 mb-1">S25 Kicker</span>
                                    <div className="flex gap-1">
                                        <input type="number" placeholder="Qty" className="w-full bg-slate-700 p-1 rounded text-white" value={extra.k_s25} onChange={e=>setExtra({...extra, k_s25: Number(e.target.value)})} />
                                        <select className="bg-slate-700 text-white rounded" value={extra.t_s25} onChange={e=>setExtra({...extra, t_s25: e.target.value})}><option value="low">Low</option><option value="high">High</option></select>
                                    </div>
                                </div>
                            </div>
                        </Card>
                        
                        {/* 5. BUNDLES & ACC */}
                        <Card className="border-l-4 border-l-orange-500 md:col-span-2">
                             <div className="flex justify-between mb-4">
                                <h3 className="font-bold text-white flex items-center gap-2"><LucideIcon name="package" size={18} className="text-orange-400"/> Bundles & Accessories</h3>
                            </div>
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                                {((settings.channel === 'exclusive' ? config.bun.excl : config.bun.std) || []).map((b, i) => (
                                    <div key={i} className="bg-slate-800 p-2 rounded text-center">
                                        <div className="text-[10px] font-bold text-slate-400 truncate uppercase">{b.name}</div>
                                        <div className="flex items-center justify-center gap-1 mt-1">
                                            <span className="text-xs text-slate-500">â‚¹{b.rate} x</span>
                                            <input type="number" className="w-10 bg-slate-700 text-white text-xs p-1 rounded text-center" value={rows.bun[i] || ''} onChange={e => setRows(prev => ({ ...prev, bun: { ...prev.bun, [i]: parseInt(e.target.value) || 0 } }))} />
                                        </div>
                                    </div>
                                ))}
                            </div>
                            <div className="flex gap-4 items-center border-t border-slate-700 pt-3">
                                <span className="text-xs font-bold text-slate-400">Accessories</span>
                                <input type="number" placeholder="Acc Value" className="w-24 bg-slate-800 text-white text-xs p-2 rounded" value={extra.accVal||''} onChange={e=>setExtra({...extra, accVal: Number(e.target.value)})} />
                                <input type="number" placeholder="Base Val (Auto)" className="w-24 bg-slate-800 text-white text-xs p-2 rounded" value={extra.accBase||''} onChange={e=>setExtra({...extra, accBase: Number(e.target.value)})} />
                            </div>
                        </Card>
                    </div>

                    <Modal isOpen={showConfig} onClose={() => setShowConfig(false)} title="Configuration">
                        <div className="space-y-4">
                            <p className="text-xs text-slate-400 bg-slate-800 p-2 rounded">
                                Edit incentive rates and logic. JSON format is used for portability.
                            </p>
                            <textarea 
                                className="w-full h-96 bg-slate-950 text-emerald-400 font-mono text-xs p-4 rounded-xl border border-slate-800 focus:outline-none"
                                value={JSON.stringify(config, null, 2)}
                                onChange={(e) => {
                                    try {
                                        setConfig(JSON.parse(e.target.value));
                                    } catch(err) { /* invalid json */ }
                                }}
                            ></textarea>
                            <div className="flex justify-end gap-2">
                                <Button onClick={() => { 
                                    confirm({
                                        title: "Reset Configuration?",
                                        message: "This will revert all rates and slabs to default v15.3 settings.",
                                        isDanger: true,
                                        onConfirm: () => { setConfig(DEFAULTS); toast.addToast("Configuration reset to defaults.", "info"); }
                                    });
                                }} variant="danger">Reset Defaults</Button>
                                <Button onClick={() => setShowConfig(false)} variant="primary">Close</Button>
                            </div>
                        </div>
                    </Modal>

                </div>
            );
        };
        const DocsHub = () => {
            const [files, setFiles] = useState([]);
            const [loading, setLoading] = useState(false);
            const [viewingFile, setViewingFile] = useState(null);
            const toast = useToast();
            const confirm = useConfirm();

            useEffect(() => {
                loadFiles();
            }, []);

            const loadFiles = async () => {
                setLoading(true);
                try {
                    const loaded = await getFilesFromDB();
                    setFiles(loaded);
                } catch (e) {
                    console.error(e);
                } finally {
                    setLoading(false);
                }
            };

            const handleUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                // Limit: 10MB to be safe with browser limits per file
                if (file.size > 10 * 1024 * 1024) {
                    toast.addToast("File too large (Max 10MB).", "error");
                    return;
                }

                setLoading(true);
                try {
                    await saveFileToDB(file);
                    await loadFiles();
                    toast.addToast("Document uploaded successfully.", "success");
                } catch (e) {
                    console.error(e);
                    toast.addToast("Error saving file. Storage might be full.", "error");
                } finally {
                    setLoading(false);
                }
            };

            const handleDelete = async (id) => {
                confirm({
                    title: "Delete Document?",
                    message: "This action cannot be undone.",
                    isDanger: true,
                    onConfirm: async () => {
                        setLoading(true);
                        try {
                            await deleteFileFromDB(id);
                            await loadFiles();
                            toast.addToast("Document deleted.", "info");
                        } catch (e) {
                            console.error(e);
                            toast.addToast("Failed to delete document.", "error");
                        } finally {
                            setLoading(false);
                        }
                    }
                });
            };

            const handleView = (file) => {
                const blob = new Blob([file.data], { type: file.type });
                const url = URL.createObjectURL(blob);
                // Open in new tab
                window.open(url, '_blank');
            };

            return (
                <div className="p-6 pb-24 animate-fade-in">
                    <div className="flex justify-between items-center mb-8">
                        <div>
                            <h2 className="text-2xl font-bold text-white flex items-center gap-3">
                                <LucideIcon name="folder" className="text-purple-400" size={28} />
                                Scheme Documents
                            </h2>
                            <p className="text-slate-400 text-sm mt-1">Archive for monthly schemes and policy documents.</p>
                        </div>
                        <div className="relative">
                            <input 
                                type="file" 
                                id="doc-upload" 
                                className="hidden" 
                                accept=".pdf,.png,.jpg,.jpeg,.xlsx" 
                                onChange={handleUpload}
                            />
                            <label 
                                htmlFor="doc-upload" 
                                className="flex items-center gap-2 bg-brand-600 hover:bg-brand-500 text-white px-5 py-3 rounded-xl font-bold text-sm cursor-pointer shadow-lg shadow-brand-900/20 transition-all active:scale-95"
                            >
                                <LucideIcon name="upload-cloud" size={18} />
                                Upload Document
                            </label>
                        </div>
                    </div>

                    {loading && (
                        <div className="flex justify-center py-12">
                            <LucideIcon name="loader" className="animate-spin text-brand-500" size={32} />
                        </div>
                    )}

                    {!loading && files.length === 0 && (
                        <div className="text-center py-20 bg-slate-800/30 rounded-3xl border border-dashed border-slate-700">
                            <div className="w-16 h-16 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-4 text-slate-500">
                                <LucideIcon name="file" size={32} />
                            </div>
                            <h3 className="text-lg font-bold text-slate-300">No Documents Found</h3>
                            <p className="text-slate-500 text-sm mt-1">Upload PDF or Image files to keep them handy.</p>
                        </div>
                    )}

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {files.map(file => (
                            <div key={file.id} className="glass-card p-4 rounded-xl flex items-center justify-between group">
                                <div className="flex items-center gap-4 overflow-hidden">
                                    <div className="w-12 h-12 rounded-lg bg-slate-800 flex items-center justify-center text-purple-400 shrink-0">
                                        <LucideIcon name={file.type.includes('pdf') ? 'file-text' : 'image'} size={24} />
                                    </div>
                                    <div className="min-w-0">
                                        <h4 className="font-bold text-slate-200 text-sm truncate">{file.name}</h4>
                                        <p className="text-xs text-slate-500 mt-0.5">
                                            {(file.size / 1024).toFixed(0)} KB â€¢ {new Date(file.date).toLocaleDateString()}
                                        </p>
                                    </div>
                                </div>
                                <div className="flex items-center gap-2">
                                    <button 
                                        onClick={() => handleView(file)} 
                                        className="p-2 text-slate-400 hover:text-brand-400 hover:bg-slate-800 rounded-lg transition-colors" 
                                        title="View"
                                    >
                                        <LucideIcon name="eye" size={18} />
                                    </button>
                                    <button 
                                        onClick={() => handleDelete(file.id)} 
                                        className="p-2 text-slate-400 hover:text-red-400 hover:bg-slate-800 rounded-lg transition-colors" 
                                        title="Delete"
                                    >
                                        <LucideIcon name="trash-2" size={18} />
                                    </button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
            <ToastProvider>
                <ConfirmProvider>
                    <App />
                </ConfirmProvider>
            </ToastProvider>
        );
    </script>
</body>
</html>
