<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>sEctrckr</title>
    <link rel="manifest" href="manifest.json">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@500;700&display=swap" rel="stylesheet">
    
    <!-- Library Imports (CDNs for reliability + Local fallback) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Inter', 'sans-serif'],
                        display: ['Outfit', 'sans-serif']
                    },
                    colors: { 
                        slate: { 850: '#151f32', 900: '#0f172a', 950: '#020617' },
                        brand: { 400: '#38bdf8', 500: '#0ea5e9', 600: '#0284c7' }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'fade-in-up': 'fadeInUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        fadeInUp: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #020617; -webkit-tap-highlight-color: transparent; color: #e2e8f0; }
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .glass-card {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.6), rgba(15, 23, 42, 0.8));
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.2s ease-in-out;
        }
        .glass-card:hover { border-color: rgba(56, 189, 248, 0.2); }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(148, 163, 184, 0.2); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(148, 163, 184, 0.4); }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        input[type="date"]::-webkit-calendar-picker-indicator,
        input[type="month"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- COMPONENTS ---
        const LucideIcon = ({ name, size = 18, className = "", onClick }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} onClick={onClick} style={{ width: size, height: size }} className={className}></i>;
        };

        const AppLogo = ({ size = "normal" }) => {
            const dim = size === "large" ? 48 : 32;
            const fontSize = size === "large" ? "text-2xl" : "text-lg";
            return (
                <div className="flex items-center gap-2">
                    <div className="relative flex items-center justify-center rounded-xl bg-gradient-to-tr from-brand-600 to-indigo-600 shadow-lg shadow-brand-500/20" style={{width: dim, height: dim}}>
                        <svg width={dim*0.6} height={dim*0.6} viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
                            <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                        </svg>
                    </div>
                    <div className="flex flex-col">
                        <h1 className={`font-display font-bold text-white ${fontSize} leading-none tracking-tight`}>sEctrckr</h1>
                        {size === "large" && <span className="text-xs text-brand-400 font-bold tracking-widest uppercase">Sales Entry & Handler</span>}
                    </div>
                </div>
            );
        };

        const Card = ({ children, className = "" }) => <div className={`glass-card rounded-2xl p-5 ${className}`}>{children}</div>;

        const Button = ({ children, onClick, variant = 'primary', className = "", icon = null }) => {
            const base = "px-4 py-3 rounded-xl font-bold text-sm transition-all active:scale-95 flex items-center justify-center gap-2";
            const variants = {
                primary: "bg-brand-600 text-white shadow-lg shadow-brand-900/20 hover:bg-brand-500",
                secondary: "bg-slate-700 text-slate-200 hover:bg-slate-600",
                outline: "border border-slate-600 text-slate-400 hover:bg-slate-800 hover:text-white",
                danger: "bg-red-500/10 text-red-500 border border-red-500/20 hover:bg-red-500/20"
            };
            return <button onClick={onClick} className={`${base} ${variants[variant]} ${className}`}>{icon && <LucideIcon name={icon} size={18} />}{children}</button>;
        };

        const Input = ({ label, value, onChange, type = "text", placeholder = "", className = "" }) => (
            <div className={`w-full ${className}`}>
                {label && <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1.5 block ml-1">{label}</label>}
                <input type={type} value={value} onChange={onChange} placeholder={placeholder}
                    className="w-full h-12 px-4 rounded-xl bg-slate-800/50 border border-slate-700 text-sm font-bold text-white focus:border-brand-500 focus:outline-none focus:ring-1 focus:ring-brand-500/50 placeholder-slate-500 transition-all" />
            </div>
        );

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-fade-in">
                    <div className="bg-slate-900 border border-slate-700 rounded-3xl w-full max-w-lg max-h-[90vh] flex flex-col shadow-2xl">
                        <div className="p-4 border-b border-slate-800 flex justify-between items-center bg-slate-800/50 shrink-0">
                            <h3 className="font-bold text-white text-lg">{title}</h3>
                            <button onClick={onClose} className="p-2 hover:bg-slate-700 rounded-lg text-slate-400 hover:text-white"><LucideIcon name="x" /></button>
                        </div>
                        <div className="p-6 overflow-y-auto custom-scrollbar flex-1">{children}</div>
                    </div>
                </div>
            );
        };

        const ConfirmModal = ({ isOpen, onClose, onConfirm, title, message, isDanger = false }) => {
            if (!isOpen) return null;
            return (
                <Modal isOpen={isOpen} onClose={onClose} title={title}>
                    <div className="space-y-4">
                        <p className="text-slate-300 text-sm">{message}</p>
                        <div className="flex gap-3 justify-end">
                            <Button onClick={onClose} variant="secondary">Cancel</Button>
                            <Button onClick={onConfirm} variant={isDanger ? "danger" : "primary"}>Confirm</Button>
                        </div>
                    </div>
                </Modal>
            );
        };

        // --- GLOBAL CONTEXTS ---
        const ToastContext = React.createContext();
        const useToast = () => React.useContext(ToastContext);
        const ToastProvider = ({ children }) => {
            const [toasts, setToasts] = useState([]);
            const addToast = (message, type = 'info') => {
                const id = Date.now() + Math.random();
                setToasts(prev => [...prev, { id, message, type }]);
                setTimeout(() => setToasts(prev => prev.filter(t => t.id !== id)), 3000);
            };
            return (
                <ToastContext.Provider value={{ addToast }}>
                    {children}
                    <div className="fixed bottom-4 right-4 z-[110] flex flex-col gap-2">
                        {toasts.map(t => (
                            <div key={t.id} className={`min-w-[200px] p-4 rounded-xl shadow-lg border backdrop-blur-md animate-fade-in-up flex items-center gap-3 ${
                                t.type === 'error' ? 'bg-red-500/10 border-red-500/20 text-red-400' :
                                t.type === 'success' ? 'bg-emerald-500/10 border-emerald-500/20 text-emerald-400' :
                                'bg-slate-800/90 border-slate-700 text-white' }`}>
                                <LucideIcon name={t.type === 'error' ? 'alert-circle' : t.type === 'success' ? 'check-circle' : 'info'} size={20} />
                                <span className="text-sm font-bold">{t.message}</span>
                            </div>
                        ))}
                    </div>
                </ToastContext.Provider>
            );
        };

        const ConfirmContext = React.createContext();
        const useConfirm = () => React.useContext(ConfirmContext);
        const ConfirmProvider = ({ children }) => {
            const [state, setState] = useState({ isOpen: false, title: "", message: "", onConfirm: null, isDanger: false });
            const confirm = (opts) => setState({ ...opts, isOpen: true });
            return (
                <ConfirmContext.Provider value={confirm}>
                    {children}
                    <ConfirmModal isOpen={state.isOpen} onClose={() => setState({ ...state, isOpen: false })} onConfirm={() => { state.onConfirm && state.onConfirm(); setState({ ...state, isOpen: false }); }} title={state.title} message={state.message} isDanger={state.isDanger} />
                </ConfirmContext.Provider>
            );
        };

        // --- SETTINGS GUI ---
        const SettingsModal = ({ isOpen, onClose, config, setConfig }) => {
            const [section, setSection] = useState('sp');
            const [tempConfig, setTempConfig] = useState(null);
            useEffect(() => { if(isOpen) setTempConfig(JSON.parse(JSON.stringify(config))); }, [isOpen, config]);
            if(!isOpen || !tempConfig) return null;

            const renderSlabEditor = (key, label) => (
                <div className="space-y-3">
                    <h4 className="font-bold text-white text-sm uppercase tracking-wider mb-2">{label} Slabs</h4>
                    {tempConfig[key].slabs.map((slab, idx) => (
                        <div key={idx} className="flex gap-2 items-center bg-slate-800/50 p-2 rounded-lg">
                            <div className="flex-1">
                                <label className="text-[10px] text-slate-400 block">Min</label>
                                <input type="number" value={slab.min} onChange={(e) => {
                                    const newSlabs = [...tempConfig[key].slabs];
                                    newSlabs[idx].min = Number(e.target.value);
                                    setTempConfig({...tempConfig, [key]: {...tempConfig[key], slabs: newSlabs}});
                                }} className="bg-transparent text-white font-bold w-full outline-none text-xs"/>
                            </div>
                            <div className="flex-1">
                                <label className="text-[10px] text-slate-400 block">Rate</label>
                                <input type="number" value={slab.rate} onChange={(e) => {
                                    const newSlabs = [...tempConfig[key].slabs];
                                    newSlabs[idx].rate = Number(e.target.value);
                                    setTempConfig({...tempConfig, [key]: {...tempConfig[key], slabs: newSlabs}});
                                }} className="bg-transparent text-emerald-400 font-bold w-full outline-none text-xs"/>
                            </div>
                            <button onClick={() => {
                                const newSlabs = tempConfig[key].slabs.filter((_, i) => i !== idx);
                                setTempConfig({...tempConfig, [key]: {...tempConfig[key], slabs: newSlabs}});
                            }} className="text-red-400 p-1"><LucideIcon name="trash" size={14}/></button>
                        </div>
                    ))}
                    <Button variant="secondary" onClick={() => {
                        const newSlabs = [...tempConfig[key].slabs, { min: 0, rate: 0, label: "New Slab" }];
                        setTempConfig({...tempConfig, [key]: {...tempConfig[key], slabs: newSlabs}});
                    }} icon="plus" className="w-full py-2 text-xs">Add Slab</Button>
                </div>
            );

            return (
                <Modal isOpen={isOpen} onClose={onClose} title="Incentive Settings">
                    <div className="flex gap-2 overflow-x-auto pb-2 mb-4 border-b border-slate-700 shrink-0 no-scrollbar">
                        {['sp', 'tb', 'cp', 'caps'].map(s => (
                            <button key={s} onClick={() => setSection(s)} className={`px-3 py-1.5 rounded-lg text-xs font-bold uppercase ${section === s ? 'bg-brand-600 text-white' : 'bg-slate-800 text-slate-400'}`}>{s}</button>
                        ))}
                    </div>
                    {section === 'sp' && renderSlabEditor('sp', 'Smartphone')}
                    {section === 'tb' && renderSlabEditor('tb', 'Tablet')}
                    {section === 'cp' && renderSlabEditor('cp', 'Care+')}
                    {section === 'caps' && (
                        <div className="space-y-4">
                                <h4 className="font-bold text-white text-sm uppercase tracking-wider mb-2">Max Caps (₹)</h4>
                                {Object.entries(tempConfig.caps).map(([k, v]) => (
                                    <div key={k} className="flex justify-between items-center bg-slate-800 p-3 rounded-xl">
                                        <span className="text-slate-300 text-sm uppercase font-bold">{k}</span>
                                        <input type="number" value={v} onChange={(e) => {
                                            setTempConfig({...tempConfig, caps: {...tempConfig.caps, [k]: Number(e.target.value)}});
                                        }} className="bg-transparent text-right text-white font-bold outline-none w-24" />
                                    </div>
                                ))}
                        </div>
                    )}
                    <div className="pt-4 mt-4 border-t border-slate-700 flex justify-end gap-2 shrink-0">
                        <Button variant="outline" onClick={onClose}>Cancel</Button>
                        <Button onClick={() => { setConfig(tempConfig); onClose(); }}>Save</Button>
                    </div>
                </Modal>
            );
        };

        const SecuritySettings = ({ isOpen, onClose }) => {
            const [mode, setMode] = useState('menu');
            const [step, setStep] = useState(0);
            const [buffer, setBuffer] = useState("");
            const [newPin, setNewPin] = useState("");
            const toast = useToast();
            const confirm = useConfirm();
            const hasPin = !!localStorage.getItem('sec_app_pin');

            const handleSetPin = (pin) => {
                if(step === 1) { setNewPin(pin); setBuffer(""); setStep(2); }
                else if (step === 2) {
                    if(pin === newPin) { localStorage.setItem('sec_app_pin', pin); toast.addToast("PIN Set!", "success"); onClose(); }
                    else { toast.addToast("Mismatch", "error"); setBuffer(""); setStep(1); }
                }
            };

            const renderKeypad = (onEnter, label) => (
                <div className="flex flex-col items-center">
                    <h3 className="text-white font-bold mb-4">{label}</h3>
                    <div className="flex gap-4 mb-6">
                        {[0, 1, 2, 3].map((i) => <div key={i} className={`w-3 h-3 rounded-full ${buffer.length > i ? 'bg-brand-500' : 'bg-slate-700'}`}></div>)}
                    </div>
                    <div className="grid grid-cols-3 gap-3 w-full max-w-[240px]">
                        {[1, 2, 3, 4, 5, 6, 7, 8, 9, 'C', 0, 'OK'].map(n => (
                            <button key={n} onClick={() => { if(n === 'C') setBuffer(buffer.slice(0, -1)); else if(n === 'OK') { if(buffer.length === 4) onEnter(buffer); } else if(buffer.length < 4) setBuffer(buffer + n); }}
                                className="h-12 bg-slate-800 rounded-xl text-white font-bold hover:bg-slate-700 flex items-center justify-center">
                                {n === 'OK' ? <LucideIcon name="check" size={16}/> : n === 'C' ? <LucideIcon name="delete" size={16}/> : n}
                            </button>
                        ))}
                    </div>
                </div>
            );

            if(!isOpen) return null;
            return (
                <Modal isOpen={isOpen} onClose={onClose} title="Security">
                    {mode === 'menu' && (
                        <div className="space-y-3">
                             <div className="p-4 bg-brand-500/10 border border-brand-500/20 rounded-xl mb-4 flex items-center gap-3">
                                <div className={`w-10 h-10 rounded-full flex items-center justify-center ${hasPin ? 'bg-emerald-500/20 text-emerald-400' : 'bg-slate-700 text-slate-400'}`}><LucideIcon name={hasPin ? "lock" : "unlock"} /></div>
                                <div><h4 className="font-bold text-white">{hasPin ? "Secured" : "Unsecured"}</h4><p className="text-xs text-slate-400">{hasPin ? "PIN active." : "Set a PIN."}</p></div>
                            </div>
                            {!hasPin ? <Button onClick={()=>{setMode('set'); setStep(1); setBuffer("");}} className="w-full" icon="plus">Set PIN</Button> :
                            <> <Button onClick={()=>{setMode('set'); setStep(1); setBuffer("");}} variant="secondary" className="w-full" icon="refresh-cw">Change PIN</Button>
                               <Button onClick={()=>{confirm({title:"Remove PIN?", message:"Sure?", isDanger:true, onConfirm:()=>{localStorage.removeItem('sec_app_pin'); onClose(); toast.addToast("Removed", "info");}})}} variant="danger" className="w-full" icon="unlock">Remove PIN</Button> </>}
                        </div>
                    )}
                    {mode === 'set' && <div><button onClick={()=>setMode('menu')} className="mb-4 text-xs text-slate-400 flex gap-1"><LucideIcon name="arrow-left" size={14}/> Back</button>{renderKeypad(handleSetPin, step === 1 ? "Enter New PIN" : "Confirm")}</div>}
                </Modal>
            );
        };

        const LockScreen = ({ onUnlock }) => {
            const [pin, setPin] = useState("");
            const [error, setError] = useState(false);
            const handleUnlock = () => { if (localStorage.getItem('sec_app_pin') === pin) onUnlock(); else { setError(true); setPin(""); setTimeout(() => setError(false), 1000); } };
            return (
                <div className="fixed inset-0 z-[100] bg-slate-950 flex flex-col items-center justify-center p-4">
                    <div className="mb-8 scale-150"><AppLogo size="large" /></div>
                    <div className="flex gap-4 mb-8">
                        {[0, 1, 2, 3].map((i) => <div key={i} className={`w-4 h-4 rounded-full ${pin.length > i ? 'bg-brand-500' : 'bg-slate-800'}`}></div>)}
                    </div>
                    <div className="grid grid-cols-3 gap-4 w-full max-w-xs">
                        {[1, 2, 3, 4, 5, 6, 7, 8, 9, 'C', 0, 'Go'].map(n => (
                            <button key={n} onClick={() => { if(n === 'C') setPin(pin.slice(0, -1)); else if(n === 'Go') handleUnlock(); else if(pin.length < 4) setPin(pin + n); }}
                                className={`h-16 rounded-2xl font-bold text-xl flex items-center justify-center ${n === 'Go' ? 'bg-brand-600 text-white' : 'bg-slate-800 text-white'}`}>
                                {n === 'Go' ? <LucideIcon name="arrow-right" /> : n === 'C' ? <LucideIcon name="delete" /> : n}
                            </button>
                        ))}
                    </div>
                    {error && <p className="text-red-500 mt-6 animate-bounce font-bold">Incorrect PIN</p>}
                </div>
            );
        };

        const AutoLockOverlay = ({ onUnlock }) => (
            <div className="fixed inset-0 z-[120] bg-black/95 flex flex-col items-center justify-center animate-fade-in p-6">
                <div className="mb-6 opacity-50"><LucideIcon name="lock" size={64} className="text-slate-500" /></div>
                <h2 className="text-2xl font-bold text-white mb-2">App Locked</h2>
                <button onClick={onUnlock} className="px-8 py-3 bg-brand-600 rounded-xl text-white font-bold text-lg hover:bg-brand-500 transition-all active:scale-95 shadow-lg shadow-brand-500/20">
                    Unlock
                </button>
            </div>
        );

        // --- APP ---
        const App = () => {
            const [view, setView] = useState('home');
            const [isLocked, setIsLocked] = useState(false);
            const [showSecurity, setShowSecurity] = useState(false);
            const [darkMode, setDarkMode] = useState(true);
            const [isAutoLocked, setIsAutoLocked] = useState(false);
            const timerRef = useRef(null);

            useEffect(() => { if (localStorage.getItem('sec_app_pin')) setIsLocked(true); }, []);
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [view, isLocked, darkMode, isAutoLocked]);

            useEffect(() => {
                if(darkMode) document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
            }, [darkMode]);

            // --- Auto Lock Logic ---
            const resetTimer = () => {
                if(timerRef.current) clearTimeout(timerRef.current);
                if(!isLocked && !isAutoLocked) {
                    timerRef.current = setTimeout(() => {
                         // Only lock if we are not already locked or in security flow
                         setIsAutoLocked(true);
                    }, 10 * 60 * 1000); // 10 minutes
                }
            };

            useEffect(() => {
                const events = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
                const handler = () => resetTimer();
                events.forEach(e => window.addEventListener(e, handler));
                resetTimer();
                return () => {
                    events.forEach(e => window.removeEventListener(e, handler));
                    if(timerRef.current) clearTimeout(timerRef.current);
                };
            }, [isLocked, isAutoLocked]);

            const handleAutoUnlock = () => {
                if(localStorage.getItem('sec_app_pin')) {
                    setIsAutoLocked(false);
                    setIsLocked(true); // Go to PIN screen
                } else {
                    setIsAutoLocked(false);
                }
            };

            const exitApp = () => {
                if (navigator.app && navigator.app.exitApp) {
                    navigator.app.exitApp();
                } else {
                    alert("Exit is only available in the installed Android APK.");
                }
            };

            if (isLocked) return <LockScreen onUnlock={() => setIsLocked(false)} />;

            return (
                <div className={`min-h-screen relative flex flex-col ${darkMode ? 'bg-slate-950 text-slate-100' : 'bg-slate-100 text-slate-900'} transition-colors duration-300`}>
                    {isAutoLocked && <AutoLockOverlay onUnlock={handleAutoUnlock} />}
                    <SecuritySettings isOpen={showSecurity} onClose={() => setShowSecurity(false)} />
                    {/* Fixed Header */}
                    {view !== 'home' && (
                        <header className={`sticky top-0 z-40 backdrop-blur-md border-b px-4 py-3 flex items-center justify-between ${darkMode ? 'bg-slate-950/80 border-white/5' : 'bg-white/80 border-slate-200'}`}>
                            <div className="flex items-center gap-3 cursor-pointer" onClick={() => setView('home')}><AppLogo /></div>
                            <div className="flex gap-2">
                                <button onClick={() => setIsAutoLocked(true)} className={`p-2 rounded-lg ${darkMode ? 'text-slate-400 hover:text-white hover:bg-slate-800' : 'text-slate-600 hover:text-slate-900 hover:bg-slate-200'}`}><LucideIcon name="lock" /></button>
                                <button onClick={exitApp} className={`p-2 rounded-lg ${darkMode ? 'text-red-400 hover:text-red-300 hover:bg-red-500/20' : 'text-red-500 hover:text-red-700 hover:bg-red-100'}`}><LucideIcon name="power" /></button>
                                <button onClick={() => setDarkMode(!darkMode)} className={`p-2 rounded-lg ${darkMode ? 'text-slate-400 hover:text-white hover:bg-slate-800' : 'text-slate-600 hover:text-slate-900 hover:bg-slate-200'}`}><LucideIcon name={darkMode ? "sun" : "moon"} /></button>
                            </div>
                        </header>
                    )}
                    <main className="flex-1 w-full max-w-5xl mx-auto p-4">
                        {view === 'home' && <HomeView setView={setView} openSecurity={() => setShowSecurity(true)} darkMode={darkMode} setDarkMode={setDarkMode} />}
                        {view === 'tracker' && <SalesTracker />}
                        {view === 'incentive' && <IncentiveCalculator />}
                    </main>
                </div>
            );
        };

        const HomeView = ({ setView, openSecurity, darkMode, setDarkMode }) => {
            const [name, setName] = useState("");
            useEffect(() => {
                const p = JSON.parse(localStorage.getItem('seh_profile_v16') || '{}');
                if(p.name) setName(p.name);
            }, []);

            const tools = [
               { id: 'tracker', title: "Daily Sales Tracker", subtitle: "SEH v2", desc: "Track sales with Brand, Model, Variant & Price.", icon: "bar-chart-2", color: "text-brand-400", bg: "bg-brand-500/10" },
               { id: 'incentive', title: "Incentive Calculator", subtitle: "Hybrid Structure", desc: "Calculate payouts with slabs, gates, and kicker logic.", icon: "calculator", color: "text-emerald-400", bg: "bg-emerald-500/10" },
           ];
           return (
               <div className="px-2 py-12 flex flex-col justify-center min-h-[80vh]">
                    <div className="mb-12 animate-fade-in-up flex justify-between items-start">
                       <div><div className="mb-6"><AppLogo size="large" /></div><h2 className="text-4xl font-display font-bold mb-3">Welcome Back{name ? `, ${name}` : ''}.</h2><p className="text-lg opacity-70">Sales Entry & Handler v2</p></div>
                       <div className="flex flex-col gap-2">
                           <button onClick={openSecurity} className={`p-3 rounded-xl ${darkMode ? 'bg-slate-800 text-slate-400 hover:text-white' : 'bg-slate-200 text-slate-600 hover:text-slate-900'}`}><LucideIcon name="shield-check" size={24} /></button>
                           <button onClick={() => setDarkMode(!darkMode)} className={`p-3 rounded-xl ${darkMode ? 'bg-slate-800 text-slate-400 hover:text-white' : 'bg-slate-200 text-slate-600 hover:text-slate-900'}`}><LucideIcon name={darkMode ? "sun" : "moon"} size={24} /></button>
                       </div>
                   </div>
                   <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                       {tools.map((tool, idx) => (
                           <div key={tool.id} onClick={() => setView(tool.id)} className="glass-card p-6 rounded-2xl group cursor-pointer animate-fade-in-up hover:border-brand-500/30" style={{animationDelay: `${0.1 + (idx * 0.1)}s`}}>
                               <div className="flex items-start justify-between mb-4"><div className={`w-14 h-14 rounded-2xl ${tool.bg} ${tool.color} flex items-center justify-center border border-white/5`}><LucideIcon name={tool.icon} size={28} /></div><LucideIcon name="arrow-right" size={20} className="text-slate-600 group-hover:text-brand-400 transition-all" /></div>
                               <h3 className="text-xl font-bold mb-1 group-hover:text-brand-400">{tool.title}</h3><p className="text-xs font-bold opacity-60 uppercase tracking-wider mb-3">{tool.subtitle}</p><p className="text-sm opacity-70">{tool.desc}</p>
                           </div>
                       ))}
                   </div>
               </div>
           );
       };

       // --- SALES TRACKER ---
       const SalesTracker = () => {
            const [view, setView] = useState('entry');
            const [salesData, setSalesData] = useState(() => {
                const d = localStorage.getItem('seh_sales_data_v16');
                return d ? JSON.parse(d) : {};
            });
            const [profile, setProfile] = useState(() => JSON.parse(localStorage.getItem('seh_profile_v16') || '{"name":"","outlet":""}'));
            const [currentDate, setCurrentDate] = useState(new Date().toISOString().split('T')[0]);
            const [reportMonth, setReportMonth] = useState(new Date().toISOString().slice(0, 7));

            const [queue, setQueue] = useState([]);
            const [inputs, setInputs] = useState({ brand: "", model: "", variant: "", price: "", qty: 1 });
            
            const toast = useToast();
            const confirm = useConfirm();
            const pieChartRef = useRef(null);
            const barChartRef = useRef(null);
            const chartInstances = useRef({});

            const brands = [
                { key: 'samsung', label: 'Samsung', color: '#3b82f6' }, { key: 'iphone', label: 'Apple', color: '#64748b' },
                { key: 'realme', label: 'Realme', color: '#eab308' }, { key: 'mi', label: 'Xiaomi', color: '#f97316' },
                { key: 'oppo', label: 'Oppo', color: '#10b981' }, { key: 'vivo', label: 'Vivo', color: '#06b6d4' },
                { key: 'moto', label: 'Moto', color: '#6366f1' }, { key: 'other', label: 'Others', color: '#94a3b8' }
            ];

            useEffect(() => { localStorage.setItem('seh_sales_data_v16', JSON.stringify(salesData)); }, [salesData]);
            useEffect(() => { localStorage.setItem('seh_profile_v16', JSON.stringify(profile)); }, [profile]);

            // --- Stats Logic ---
            const getStats = useMemo(() => {
                const stats = { mtd: { vol: 0, val: 0, byBrand: {} }, lmtd: { vol: 0, val: 0, byBrand: {} }, grouped: {}, segments: { '<10k':0, '10-20k':0, '20-30k':0, '30-50k':0, '>50k':0 }, ftd: { vol: 0, val: 0 } };
                brands.forEach(b => {
                    stats.mtd.byBrand[b.key] = { vol: 0, val: 0 };
                    stats.lmtd.byBrand[b.key] = { vol: 0, val: 0 };
                });

                const now = new Date(reportMonth + "-01");
                const lastMonthDate = new Date(new Date(now).setMonth(now.getMonth() - 1));
                const lastMonthStr = lastMonthDate.toISOString().slice(0, 7);

                const todayTxns = salesData[currentDate] || [];
                todayTxns.forEach(t => { stats.ftd.vol += t.qty; stats.ftd.val += t.val; });

                Object.keys(salesData).forEach(date => {
                    const txns = salesData[date];
                    if(!Array.isArray(txns)) return;

                    const isMtd = date.startsWith(reportMonth);
                    const isLmtd = date.startsWith(lastMonthStr);

                    txns.forEach(t => {
                        if(isMtd) {
                            stats.mtd.vol += t.qty; stats.mtd.val += t.val;
                            if(stats.mtd.byBrand[t.brand]) {
                                stats.mtd.byBrand[t.brand].vol += t.qty;
                                stats.mtd.byBrand[t.brand].val += t.val;
                            }
                            if(!stats.grouped[t.brand]) stats.grouped[t.brand] = { vol:0, val:0, models:{} };
                            const bGroup = stats.grouped[t.brand];
                            bGroup.vol += t.qty; bGroup.val += t.val;
                            const mKey = t.model || "Unknown";
                            if(!bGroup.models[mKey]) bGroup.models[mKey] = { vol:0, val:0, variants:{} };
                            const mGroup = bGroup.models[mKey];
                            mGroup.vol += t.qty; mGroup.val += t.val;
                            const vKey = t.variant || "Base";
                            if(!mGroup.variants[vKey]) mGroup.variants[vKey] = { vol:0, val:0 };
                            mGroup.variants[vKey].vol += t.qty; mGroup.variants[vKey].val += t.val;
                            const p = t.price;
                            if(p<10000) stats.segments['<10k'] += t.qty;
                            else if(p<20000) stats.segments['10-20k'] += t.qty;
                            else if(p<30000) stats.segments['20-30k'] += t.qty;
                            else if(p<50000) stats.segments['30-50k'] += t.qty;
                            else stats.segments['>50k'] += t.qty;
                        }
                        if(isLmtd) {
                            stats.lmtd.vol += t.qty; stats.lmtd.val += t.val;
                            if(stats.lmtd.byBrand[t.brand]) {
                                stats.lmtd.byBrand[t.brand].vol += t.qty;
                                stats.lmtd.byBrand[t.brand].val += t.val;
                            }
                        }
                    });
                });
                return stats;
            }, [salesData, currentDate, reportMonth]);

            // --- Charts ---
            useEffect(() => {
                if(view === 'analytics') {
                    if(chartInstances.current.pie) chartInstances.current.pie.destroy();
                    if(chartInstances.current.bar) chartInstances.current.bar.destroy();

                    const ctxPie = pieChartRef.current?.getContext('2d');
                    if(ctxPie) {
                        chartInstances.current.pie = new Chart(ctxPie, {
                            type: 'doughnut',
                            data: {
                                labels: ['Current Month', 'Last Month'],
                                datasets: [{
                                    data: [getStats.mtd.vol, getStats.lmtd.vol],
                                    backgroundColor: ['#0ea5e9', '#334155'],
                                    borderWidth: 0
                                }]
                            },
                            options: { responsive: true, plugins: { legend: { position: 'bottom', labels: { color: '#cbd5e1' } }, title: { display: true, text: 'Volume (MTD vs LMTD)', color: '#fff' } } }
                        });
                    }
                    const ctxBar = barChartRef.current?.getContext('2d');
                    if(ctxBar) {
                        const labels = brands.map(b => b.label);
                        const dataCurr = brands.map(b => getStats.mtd.byBrand[b.key]?.vol || 0);
                        const dataLast = brands.map(b => getStats.lmtd.byBrand[b.key]?.vol || 0);

                        chartInstances.current.bar = new Chart(ctxBar, {
                            type: 'bar',
                            data: {
                                labels,
                                datasets: [
                                    { label: 'This Month', data: dataCurr, backgroundColor: '#0ea5e9', borderRadius: 4 },
                                    { label: 'Last Month', data: dataLast, backgroundColor: '#334155', borderRadius: 4 }
                                ]
                            },
                            options: {
                                indexAxis: 'y',
                                responsive: true,
                                scales: { x: { ticks: { color: '#94a3b8' } }, y: { ticks: { color: '#94a3b8' }, grid: { display: false } } },
                                plugins: { legend: { labels: { color: '#cbd5e1' } }, title: { display: true, text: 'Brand Growth (MoM)', color: '#fff' } }
                            }
                        });
                    }
                }
            }, [view, getStats]);

            // --- Import/Export ---
            const exportData = (type) => {
                const rows = [];
                Object.entries(salesData).forEach(([date, txns]) => {
                    txns.forEach(t => {
                        rows.push({ Date: date, Time: t.time, Brand: brands.find(b=>b.key===t.brand)?.label, Model: t.model, Variant: t.variant, Price: t.price, Qty: t.qty, Value: t.val });
                    });
                });

                if(type === 'xlsx') {
                    if(!window.XLSX) { toast.addToast("XLSX lib missing", "error"); return; }
                    const ws = XLSX.utils.json_to_sheet(rows);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Transactions");
                    XLSX.writeFile(wb, "SEH_Data.xlsx");
                } else {
                    if(!window.jspdf) { toast.addToast("PDF lib missing", "error"); return; }
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    doc.text("SEH Sales Report", 14, 20);
                    doc.setFontSize(10);
                    doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 26);

                    const tableRows = rows.map(r => [r.Date, r.Brand, r.Model, r.Variant, r.Qty, r.Value]);
                    doc.autoTable({ startY: 30, head: [['Date', 'Brand', 'Model', 'Variant', 'Qty', 'Val']], body: tableRows });

                    const b64 = btoa(unescape(encodeURIComponent(JSON.stringify(salesData))));
                    doc.addPage();
                    doc.setFontSize(1);
                    doc.setTextColor(255, 255, 255);
                    doc.text(`SEH_RECOVERY::${b64}::END`, 10, 10);
                    doc.save("SEH_Report.pdf");
                }
                toast.addToast(`Exported ${type.toUpperCase()}`, "success");
            };

            const importData = (e) => {
                const file = e.target.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        if(file.name.endsWith('xlsx')) {
                            const wb = XLSX.read(evt.target.result, {type:'binary'});
                            const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                            const restored = {};
                            json.forEach(row => {
                                const d = row.Date;
                                if(!restored[d]) restored[d] = [];
                                const bKey = brands.find(b=>b.label === row.Brand)?.key || 'other';
                                restored[d].push({
                                    id: Date.now() + Math.random(), time: row.Time || '00:00:00',
                                    brand: bKey, model: row.Model, variant: row.Variant,
                                    price: Number(row.Price), qty: Number(row.Qty), val: Number(row.Value)
                                });
                            });
                            confirm({ title: "Restore Data?", message: "This will replace current data.", isDanger: true, onConfirm: () => { setSalesData(restored); toast.addToast("Restored from XLSX", "success"); }});
                        } else if(file.name.endsWith('pdf')) {
                             const txt = evt.target.result;
                             const start = txt.indexOf("SEH_RECOVERY::");
                             const end = txt.indexOf("::END");
                             if(start > -1 && end > -1) {
                                 const json = decodeURIComponent(escape(atob(txt.substring(start+14, end))));
                                 confirm({ title: "Restore Data?", message: "Replace current data?", isDanger: true, onConfirm: () => { setSalesData(JSON.parse(json)); toast.addToast("Restored from PDF", "success"); }});
                             } else { toast.addToast("No recovery data in PDF", "error"); }
                        }
                    } catch(err) { console.error(err); toast.addToast("Import Failed", "error"); }
                };
                if(file.name.endsWith('pdf')) reader.readAsText(file); else reader.readAsBinaryString(file);
            };

            const handleAdd = () => {
                if(!inputs.brand || !inputs.price) { toast.addToast("Brand & Price required", "error"); return; }
                const newItem = { id: Date.now(), ...inputs, price: Number(inputs.price), qty: Number(inputs.qty), val: Number(inputs.price)*Number(inputs.qty) };
                setQueue([...queue, newItem]);
                setInputs({ ...inputs, model:"", variant:"", price:"", qty: 1 });
            };
            const handleSave = () => {
                if(queue.length === 0) return;
                const newTxns = queue.map(q => ({ ...q, time: new Date().toLocaleTimeString() }));
                const existing = salesData[currentDate] || [];
                setSalesData({ ...salesData, [currentDate]: [...existing, ...newTxns] });
                setQueue([]);
                toast.addToast("Saved", "success");
            };

            return (
                <div className="pb-24 animate-fade-in">
                     <div className="flex justify-between items-center mb-6">
                        <div className="flex gap-2 overflow-x-auto no-scrollbar py-2 max-w-[90vw]">
                            {['entry', 'report', 'analytics', 'data', 'profile'].map(v => (
                                <button key={v} onClick={() => setView(v)} className={`px-4 py-2 rounded-xl text-xs font-bold uppercase tracking-wider whitespace-nowrap transition-all ${view === v ? 'bg-brand-600 text-white' : 'bg-slate-800 text-slate-400'}`}>{v}</button>
                            ))}
                        </div>
                    </div>

                    {/* Data View */}
                    {view === 'data' && (
                        <div className="space-y-4 animate-fade-in">
                            <Card>
                                <h3 className="font-bold text-xl mb-4 flex items-center gap-2"><LucideIcon name="database"/> Data Management</h3>
                                <div className="space-y-6">
                                    <div className="bg-slate-800/50 p-4 rounded-xl border border-slate-700/50">
                                        <h4 className="font-bold mb-2 flex items-center gap-2"><LucideIcon name="download" size={16}/> Export Data</h4>
                                        <div className="grid grid-cols-2 gap-3">
                                            <Button variant="secondary" onClick={()=>exportData('xlsx')}>Excel (.xlsx)</Button>
                                            <Button variant="secondary" onClick={()=>exportData('pdf')}>PDF (.pdf)</Button>
                                        </div>
                                    </div>
                                    <div className="bg-slate-800/50 p-4 rounded-xl border border-slate-700/50">
                                        <h4 className="font-bold mb-2 flex items-center gap-2"><LucideIcon name="rotate-ccw" size={16}/> Restore Data</h4>
                                        <p className="text-xs opacity-60 mb-4">Restore from a valid SEH Export (XLSX or PDF).</p>
                                        <div className="relative">
                                            <input type="file" id="tracker-import-modal" className="hidden" accept=".xlsx,.pdf" onChange={importData} />
                                            <label htmlFor="tracker-import-modal" className="flex items-center justify-center gap-2 w-full px-4 py-3 rounded-xl font-bold text-sm bg-brand-600 text-white shadow-lg cursor-pointer transition-all hover:bg-brand-500">
                                                Select Backup File
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </Card>
                        </div>
                    )}

                    {view === 'entry' && (
                        <div className="space-y-6">
                            <Card>
                                <div className="flex justify-between mb-4 items-center">
                                    <div className="flex items-center gap-2"><LucideIcon name="calendar" className="text-brand-400"/><input type="date" value={currentDate} onChange={e=>setCurrentDate(e.target.value)} className="bg-transparent font-bold outline-none"/></div>
                                    <button onClick={()=>setQueue([])} className="text-xs text-red-400">Clear</button>
                                </div>
                                <div className="space-y-3">
                                    <select value={inputs.brand} onChange={e=>setInputs({...inputs, brand: e.target.value})} className="w-full h-12 px-4 rounded-xl bg-slate-900 border border-slate-700 font-bold"><option value="">Select Brand</option>{brands.map(b=><option key={b.key} value={b.key}>{b.label}</option>)}</select>
                                    <div className="grid grid-cols-2 gap-3"><Input placeholder="Model" value={inputs.model} onChange={e=>setInputs({...inputs, model: e.target.value})} /><Input placeholder="Variant (8/128)" value={inputs.variant} onChange={e=>setInputs({...inputs, variant: e.target.value})} /></div>
                                    <div className="grid grid-cols-2 gap-3"><Input type="number" placeholder="Price" value={inputs.price} onChange={e=>setInputs({...inputs, price: e.target.value})} /><Input type="number" placeholder="Qty" value={inputs.qty} onChange={e=>setInputs({...inputs, qty: e.target.value})} /></div>
                                    <Button onClick={handleAdd} icon="plus" className="w-full">Add to Queue</Button>
                                </div>
                            </Card>
                            {queue.length > 0 && (
                                <div className="bg-slate-800 rounded-xl p-4">
                                    <h4 className="text-slate-300 font-bold mb-3 text-sm">Queue ({queue.length})</h4>
                                    {queue.map((item,i) => <div key={i} className="text-xs text-slate-400 border-b border-slate-700 pb-1 mb-1 flex justify-between"><span>{brands.find(b=>b.key===item.brand)?.label} {item.model} {item.variant} x{item.qty}</span><span className="text-white">₹{item.val}</span></div>)}
                                    <Button onClick={handleSave} className="w-full mt-3">Save</Button>
                                </div>
                            )}
                            {salesData[currentDate] && (
                                <Card className="border-l-4 border-l-brand-500 max-h-64 overflow-y-auto">
                                    <h4 className="text-xs font-bold opacity-60 uppercase mb-2">Today's Sales</h4>
                                    {[...salesData[currentDate]].reverse().map((t,i) => (
                                        <div key={i} className="flex justify-between text-xs py-1 border-b border-slate-800/50">
                                            <span className="opacity-80">{t.time} - {brands.find(b=>b.key===t.brand)?.label} {t.model} {t.variant} x{t.qty}</span>
                                            <span className="text-emerald-400 font-bold">₹{t.val}</span>
                                        </div>
                                    ))}
                                </Card>
                            )}
                        </div>
                    )}

                    {view === 'report' && (
                        <div className="space-y-6">
                            <div className="flex justify-between bg-slate-800 p-3 rounded-xl"><span className="text-xs font-bold text-slate-400 uppercase pt-1">Month</span><input type="month" value={reportMonth} onChange={e=>setReportMonth(e.target.value)} className="bg-transparent text-white font-bold outline-none text-right"/></div>
                            <div className="grid grid-cols-2 gap-4">
                                <Card className="p-4 bg-indigo-900/30"><div className="text-xs text-indigo-300 font-bold uppercase">Today</div><div className="text-2xl font-bold">{getStats.ftd.vol}</div><div className="text-xs text-indigo-400">₹{(getStats.ftd.val/1000).toFixed(1)}k</div></Card>
                                <Card className="p-4 bg-brand-900/30"><div className="text-xs text-brand-300 font-bold uppercase">MTD</div><div className="text-2xl font-bold">{getStats.mtd.vol}</div><div className="text-xs text-brand-400">₹{(getStats.mtd.val/1000).toFixed(1)}k</div></Card>
                            </div>
                            <Card className="p-0 overflow-hidden">
                                {brands.map(b => {
                                    const bData = getStats.grouped[b.key];
                                    return (
                                        <details key={b.key} className="group border-b border-slate-800 last:border-0">
                                            <summary className="flex justify-between p-4 cursor-pointer hover:bg-slate-800/50"><div className="flex items-center gap-3"><div className="w-3 h-3 rounded-full" style={{backgroundColor:b.color}}></div><span className="font-bold">{b.label}</span></div><div className="text-right flex items-center gap-4"><div><span className="block font-bold text-sm">{getStats.mtd.byBrand[b.key]?.vol||0}u</span></div><LucideIcon name="chevron-down" size={16} /></div></summary>
                                            <div className="px-4 pb-4 bg-slate-900/30 space-y-2">
                                                {bData ? Object.entries(bData.models).map(([mName, mData]) => (
                                                    <div key={mName} className="bg-slate-800/50 rounded p-2">
                                                        <div className="flex justify-between text-xs font-bold text-slate-300 pb-1 border-b border-slate-700/50"><span>{mName}</span><span>{mData.vol}u</span></div>
                                                        {Object.entries(mData.variants).map(([vName, vData]) => <div key={vName} className="flex justify-between text-[10px] text-slate-400 pt-1 pl-2"><span>{vName}</span><span>{vData.vol}u</span></div>)}
                                                    </div>
                                                )) : <p className="text-xs text-slate-500 italic">No sales.</p>}
                                            </div>
                                        </details>
                                    );
                                })}
                            </Card>
                        </div>
                    )}

                    {view === 'analytics' && (
                        <div className="space-y-6">
                            <div className="flex justify-between bg-slate-800 p-3 rounded-xl"><span className="text-xs font-bold text-slate-400 uppercase pt-1">Month</span><input type="month" value={reportMonth} onChange={e=>setReportMonth(e.target.value)} className="bg-transparent text-white font-bold outline-none text-right"/></div>
                            <div className="grid md:grid-cols-2 gap-4"><Card><canvas ref={pieChartRef}></canvas></Card><Card><canvas ref={barChartRef}></canvas></Card></div>
                            <Card>
                                <h3 className="font-bold mb-4">Price Segmentation</h3>
                                <div className="space-y-3">
                                    {Object.entries(getStats.segments).map(([seg, val]) => (
                                        <div key={seg}>
                                            <div className="flex justify-between text-xs opacity-70 mb-1"><span>{seg}</span><span>{val} u</span></div>
                                            <div className="h-1.5 bg-slate-800 rounded-full"><div className="h-full bg-brand-500 rounded-full" style={{width: `${getStats.mtd.vol>0 ? (val/getStats.mtd.vol)*100 : 0}%`}}></div></div>
                                        </div>
                                    ))}
                                </div>
                            </Card>
                        </div>
                    )}

                    {view === 'profile' && (
                        <Card>
                            <div className="text-center mb-6"><div className="w-16 h-16 bg-slate-800 rounded-full mx-auto flex items-center justify-center mb-3"><LucideIcon name="user" size={32} className="text-slate-500" /></div><h3 className="font-bold">Profile</h3></div>
                            <div className="space-y-4">
                                <Input label="Name" value={profile.name} onChange={e=>setProfile({...profile, name: e.target.value})} />
                                <Input label="Outlet" value={profile.outlet} onChange={e=>setProfile({...profile, outlet: e.target.value})} />
                                <Button onClick={()=>{localStorage.setItem('seh_profile_v16', JSON.stringify(profile)); toast.addToast("Profile Saved", "success");}} className="w-full">Save Profile</Button>
                            </div>
                        </Card>
                    )}
                </div>
            );
       };

       // --- INCENTIVE CALC (Fixed: Modal Selection + Missing Categories) ---
       const IncentiveCalculator = () => {
           const [rows, setRows] = useState({ sp: [], tb: [], wr: [], cp: [], npc: [], bun: [], acc: [] });
           const [settings, setSettings] = useState({ channel: 'standard', status: 'existing', enforceGates: false });
           const [config, setConfig] = useState(() => JSON.parse(localStorage.getItem('sec_incentive_config')) || {
                sp: { slabs: [{min:100000,rate:700},{min:0,rate:25}], gates:{std:[{min:40,p:1}], sis:[{min:40,p:1}]}, fm_mult:0.5 },
                tb: { slabs: [{min:70000,rate:800},{min:10000,rate:100}], focus: [{name:"S11 Ultra", rate:1500}, {name:"S10 Lite", rate:750}] },
                wr: [{name:"Watch Ultra", rate:1200}, {name:"Buds3 Pro", rate:600}],
                cp: { slabs: [{min:100000,rate:400},{min:0,rate:50}], kickers: { ff7:{l:400,h:600}, s25:{l:300,h:500} } },
                npc: [{name:"GB5 Pro", rate:3000}, {name:"GB4", rate:1250}],
                bun: { std: [{name:"Wr+Hr", rate:750}], excl: [{name:"Wr+Hr+Acc", rate:1000}] },
                acc: [{min:4,rate:3000}],
                caps: { global:75000, tb:20000, npc:50000, bun:10000 }
           });
           const [extra, setExtra] = useState({ accVal:0, accBase:0, k_ff7:0, t_ff7:'low', k_s25:0, t_s25:'low' });
           const [result, setResult] = useState({ total: 0, logs: [] });

           // UI States
           const [showSettings, setShowSettings] = useState(false);
           const [showSelection, setShowSelection] = useState(false);
           const [activeCat, setActiveCat] = useState('sp'); // Category being added

           useEffect(() => localStorage.setItem('sec_incentive_config', JSON.stringify(config)), [config]);

           // Calc Logic (Simplified for brevity but structurally complete for categories)
           useEffect(() => {
                let logs = []; let total = 0;
                const c = config;

                // 1. SP
                let spQ = 0, spRaw = 0;
                rows.sp.forEach(r => { spQ += r.qty; spRaw += r.qty * (r.fm ? r.rate * c.sp.fm_mult : r.rate); });
                logs.push({ cat: "Smartphones", val: spRaw }); total += spRaw;

                // 2. TB
                let tbTot = 0;
                rows.tb.forEach(r => { tbTot += r.qty * r.rate; });
                logs.push({ cat: "Tablets", val: tbTot }); total += tbTot;

                // 3. WR
                let wrTot = 0;
                rows.wr.forEach(r => { wrTot += r.qty * r.rate; });
                logs.push({ cat: "Wearables", val: wrTot }); total += wrTot;

                // 4. CP
                let cpTot = 0;
                rows.cp.forEach(r => { cpTot += r.qty * r.rate; });
                logs.push({ cat: "Care+", val: cpTot }); total += cpTot;

                // 5. NPC
                let npcTot = 0;
                rows.npc.forEach(r => { npcTot += r.qty * r.rate; });
                logs.push({ cat: "Note PC", val: npcTot }); total += npcTot;

                // 6. Bundles
                let bunTot = 0;
                rows.bun.forEach(r => { bunTot += r.qty * r.rate; });
                logs.push({ cat: "Bundles", val: bunTot }); total += bunTot;

                // 7. Acc
                let accTot = 0;
                rows.acc.forEach(r => { accTot += r.qty * r.rate; }); // Simple qty * rate logic for visual
                logs.push({ cat: "Accessories", val: accTot }); total += accTot;

                setResult({ total, logs });
           }, [rows, extra, config, settings]);

           const addRow = (cat, item) => {
               setRows(p => ({...p, [cat]: [...p[cat], {id:Date.now(), qty:1, name: item.name || item.label || 'Item', rate: item.rate}]}));
               setShowSelection(false);
           };
           const delRow = (cat, id) => setRows(p => ({...p, [cat]: p[cat].filter(r => r.id !== id)}));

           const openModal = (cat) => { setActiveCat(cat); setShowSelection(true); };

           return (
               <div className="pb-24 animate-fade-in space-y-4">
                   <SettingsModal isOpen={showSettings} onClose={()=>setShowSettings(false)} config={config} setConfig={setConfig} />

                   {/* Selection Modal */}
                   <Modal isOpen={showSelection} onClose={()=>setShowSelection(false)} title={`Select ${activeCat.toUpperCase()}`}>
                       <div className="grid gap-2">
                           {activeCat === 'sp' && config.sp.slabs.map((s,i)=><button key={i} onClick={()=>addRow('sp', s)} className="p-3 bg-slate-800 rounded-lg text-left hover:bg-slate-700"><div className="font-bold">{s.label || s.min+'+'}</div><div className="text-xs text-brand-400">₹{s.rate}</div></button>)}
                           {activeCat === 'tb' && [...config.tb.focus, ...config.tb.slabs].map((s,i)=><button key={i} onClick={()=>addRow('tb', s)} className="p-3 bg-slate-800 rounded-lg text-left hover:bg-slate-700"><div className="font-bold">{s.name || s.min+'+'}</div><div className="text-xs text-brand-400">₹{s.rate}</div></button>)}
                           {activeCat === 'cp' && config.cp.slabs.map((s,i)=><button key={i} onClick={()=>addRow('cp', s)} className="p-3 bg-slate-800 rounded-lg text-left hover:bg-slate-700"><div className="font-bold">{s.min}+</div><div className="text-xs text-brand-400">₹{s.rate}</div></button>)}
                           {activeCat === 'wr' && config.wr.map((s,i)=><button key={i} onClick={()=>addRow('wr', s)} className="p-3 bg-slate-800 rounded-lg text-left hover:bg-slate-700"><div className="font-bold">{s.name}</div><div className="text-xs text-brand-400">₹{s.rate}</div></button>)}
                           {activeCat === 'npc' && config.npc.map((s,i)=><button key={i} onClick={()=>addRow('npc', s)} className="p-3 bg-slate-800 rounded-lg text-left hover:bg-slate-700"><div className="font-bold">{s.name}</div><div className="text-xs text-brand-400">₹{s.rate}</div></button>)}
                           {activeCat === 'bun' && config.bun.std.map((s,i)=><button key={i} onClick={()=>addRow('bun', s)} className="p-3 bg-slate-800 rounded-lg text-left hover:bg-slate-700"><div className="font-bold">{s.name}</div><div className="text-xs text-brand-400">₹{s.rate}</div></button>)}
                       </div>
                   </Modal>

                   <div className="bg-emerald-900/20 p-6 rounded-3xl border border-emerald-500/30 flex justify-between items-center">
                       <div><h2 className="text-3xl font-bold">₹{Math.floor(result.total).toLocaleString()}</h2><p className="text-emerald-400 text-xs font-bold uppercase">Payout</p></div>
                       <div className="flex gap-2"><button onClick={()=>setRows({sp:[],tb:[],wr:[],cp:[],npc:[],bun:[],acc:[]})} className="p-3 bg-red-500/10 rounded-xl text-red-400"><LucideIcon name="trash-2" /></button><button onClick={()=>setShowSettings(true)} className="p-3 bg-white/10 rounded-xl text-white"><LucideIcon name="settings" /></button></div>
                   </div>

                   {/* Main Categories */}
                   {['sp', 'tb', 'wr', 'cp', 'npc', 'bun', 'acc'].map(cat => (
                       <Card key={cat} className={`border-l-4 ${cat==='sp'?'border-blue-500':cat==='tb'?'border-emerald-500':'border-slate-500'}`}>
                           <div className="flex justify-between mb-2">
                               <h3 className="font-bold uppercase text-sm">{cat === 'sp' ? 'Smartphones' : cat === 'tb' ? 'Tablets' : cat === 'wr' ? 'Wearables' : cat === 'cp' ? 'Care+' : cat === 'npc' ? 'Note PC' : cat === 'bun' ? 'Bundles' : 'Accessories'}</h3>
                               <button onClick={()=>openModal(cat)} className="text-brand-400 text-xs font-bold">+ Add</button>
                           </div>
                           {rows[cat].map(r => (
                               <div key={r.id} className="flex gap-2 mb-2 items-center text-xs">
                                   <div className="flex-1 bg-slate-800 rounded p-2 text-white font-bold">{r.name}</div>
                                   <input type="number" className="w-12 bg-slate-800 rounded p-2 text-center" value={r.qty} onChange={e=>{const n=Number(e.target.value); setRows(p=>({...p, [cat]: p[cat].map(x=>x.id===r.id?{...x,qty:n}:x)}))}} />
                                   <div className="w-16 text-right font-bold text-emerald-400">₹{r.rate * r.qty}</div>
                                   <button onClick={()=>delRow(cat, r.id)} className="text-red-400"><LucideIcon name="x" size={14}/></button>
                               </div>
                           ))}
                           {rows[cat].length === 0 && <p className="text-[10px] opacity-40 italic">No entries.</p>}
                       </Card>
                   ))}

                   {/* Breakdown */}
                   <div className="space-y-1 bg-slate-800/50 p-3 rounded-xl border border-slate-700/50">
                       <h4 className="text-xs font-bold uppercase opacity-60 mb-2">Summary</h4>
                       {result.logs.map((l,i) => <div key={i} className="flex justify-between text-xs opacity-80"><span>{l.cat} {l.note && `(${l.note})`}</span><span>₹{Math.floor(l.val).toLocaleString()}</span></div>)}
                   </div>
               </div>
           );
       };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ToastProvider><ConfirmProvider><App /></ConfirmProvider></ToastProvider>);
    </script>
</body>
</html>
